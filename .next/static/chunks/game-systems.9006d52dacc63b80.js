"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[893],{5050:function(e,t,i){i.d(t,{Ge:function(){return o},g3:function(){return r},j4:function(){return n}});let s=0,a=0;function n(e){s=e}function o(e){a=e}function r(e){let t=Math.random()<.11+.03*s,i=2+.15*a;return{damage:Math.floor(t?e*i:e),isCritical:t}}},45:function(e,t,i){i.d(t,{D:function(){return r}});var s=i(4058),a=i(948);class n extends a.v{start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.accumulator=0,this.frameId=requestAnimationFrame(this.gameLoop.bind(this)))}stop(){this.isRunning&&(this.isRunning=!1,this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=0))}getCurrentFPS(){return this.currentFPS}getFixedTimeStep(){return this.fixedTimeStep}gameLoop(e){if(!this.isRunning)return;let t=Math.min((e-this.lastTime)/1e3,this.maxFrameTime);this.lastTime=e,this.currentTime=e,this.updateFPS(t),this.accumulator+=t;let i=0;for(;this.accumulator>=this.fixedTimeStep&&i<this.maxSubSteps;)this.emit("fixedUpdate",{fixedDeltaTime:this.fixedTimeStep}),this.accumulator-=this.fixedTimeStep,i++;this.emit("update",{deltaTime:t});let s=this.accumulator/this.fixedTimeStep;this.emit("render",{deltaTime:t,interpolation:s}),this.frameId=requestAnimationFrame(this.gameLoop.bind(this))}updateFPS(e){this.frameCount++,this.fpsUpdateTime+=e,this.fpsUpdateTime>=1&&(this.currentFPS=Math.round(this.frameCount/this.fpsUpdateTime),this.frameCount=0,this.fpsUpdateTime=0)}pause(){this.isRunning&&this.stop()}resume(){this.isRunning||this.start()}isPaused(){return!this.isRunning}getCurrentTime(){return this.currentTime}getInterpolationRatio(){return this.accumulator/this.fixedTimeStep}constructor(){super(),this.isRunning=!1,this.lastTime=0,this.accumulator=0,this.currentTime=0,this.frameId=0,this.fixedTimeStep=1/60,this.maxFrameTime=1/30,this.maxSubSteps=5,this.frameCount=0,this.fpsUpdateTime=0,this.currentFPS=0}}class o extends a.v{initialize(e){this.canvas=e,e.addEventListener("mousedown",this.onMouseDown.bind(this)),e.addEventListener("mouseup",this.onMouseUp.bind(this)),e.addEventListener("mousemove",this.onMouseMove.bind(this)),e.addEventListener("wheel",this.onWheel.bind(this),{passive:!1}),e.addEventListener("contextmenu",e=>e.preventDefault())}requestPointerLock(){this.canvas&&this.canvas.requestPointerLock()}exitPointerLock(){document.exitPointerLock()}isKeyPressed(e){return this.keys.has(e.toLowerCase())}isMouseButtonPressed(e){return this.mouseButtons.has(e)}getMousePosition(){return{...this.mousePosition}}getMouseDelta(){return{...this.mouseDelta}}getInputState(){return{keys:new Set(this.keys),mouse:{x:this.mousePosition.x,y:this.mousePosition.y,deltaX:this.mouseDelta.x,deltaY:this.mouseDelta.y,buttons:new Set(this.mouseButtons)}}}checkDoubleTap(e){let t=e.toLowerCase(),i=this.keyTimings.get(t);return!!i&&(Date.now(),!!i.hasValidFirstTap&&!!i.isInDoubleTapSequence&&i.secondPressTime>0&&i.secondPressTime-i.firstReleaseTime<=this.DOUBLE_TAP_THRESHOLD)}resetDoubleTap(e){let t=e.toLowerCase(),i=this.keyTimings.get(t);i&&(i.firstPressTime=0,i.firstReleaseTime=0,i.secondPressTime=0,i.isInDoubleTapSequence=!1,i.hasValidFirstTap=!1)}update(){this.mouseDelta.x=0,this.mouseDelta.y=0,this.cleanupOldTimings()}cleanupOldTimings(){let e=Date.now(),t=[];this.keyTimings.forEach((i,s)=>{let a=Math.max(i.firstPressTime,i.firstReleaseTime,i.secondPressTime);a>0&&e-a>5e3&&t.push(s)}),t.forEach(e=>this.keyTimings.delete(e))}getDoubleTapDebugInfo(e){let t=e.toLowerCase(),i=this.keyTimings.get(t);if(!i)return null;let s=Date.now();return{key:t,firstPressTime:i.firstPressTime,firstReleaseTime:i.firstReleaseTime,secondPressTime:i.secondPressTime,hasValidFirstTap:i.hasValidFirstTap,isInDoubleTapSequence:i.isInDoubleTapSequence,timeSinceFirstPress:i.firstPressTime>0?s-i.firstPressTime:0,timeSinceFirstRelease:i.firstReleaseTime>0?s-i.firstReleaseTime:0,timeSinceSecondPress:i.secondPressTime>0?s-i.secondPressTime:0,threshold:this.DOUBLE_TAP_THRESHOLD}}setupEventListeners(){document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this)),document.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),document.addEventListener("mousemove",this.onMouseMove.bind(this)),document.addEventListener("wheel",this.onWheel.bind(this),{passive:!1}),document.addEventListener("pointerlockchange",this.onPointerLockChange.bind(this)),document.addEventListener("pointerlockerror",this.onPointerLockError.bind(this)),document.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("blur",this.onWindowBlur.bind(this)),window.addEventListener("focus",this.onWindowFocus.bind(this))}onKeyDown(e){let t=e.key.toLowerCase();if(!this.keys.has(t)){this.keys.add(t),this.emit("keyDown",{key:e.key,code:e.code});let i=Date.now(),s=this.keyTimings.get(t);s||(s={firstPressTime:0,firstReleaseTime:0,secondPressTime:0,isInDoubleTapSequence:!1,hasValidFirstTap:!1},this.keyTimings.set(t,s)),s.hasValidFirstTap?s.hasValidFirstTap&&!s.isInDoubleTapSequence&&(i-s.firstReleaseTime<=this.DOUBLE_TAP_THRESHOLD?(s.secondPressTime=i,s.isInDoubleTapSequence=!0):(s.firstPressTime=i,s.firstReleaseTime=0,s.secondPressTime=0,s.isInDoubleTapSequence=!1,s.hasValidFirstTap=!1)):(s.firstPressTime=i,s.isInDoubleTapSequence=!1,s.hasValidFirstTap=!1)}this.isGameKey(t)&&e.preventDefault()}onKeyUp(e){let t=e.key.toLowerCase();if(this.keys.has(t)){this.keys.delete(t),this.emit("keyUp",{key:e.key,code:e.code});let i=this.keyTimings.get(t);if(i){let e=Date.now();!i.hasValidFirstTap&&i.firstPressTime>0?(i.firstReleaseTime=e,i.hasValidFirstTap=!0):i.isInDoubleTapSequence&&setTimeout(()=>{i&&(i.firstPressTime=0,i.firstReleaseTime=0,i.secondPressTime=0,i.isInDoubleTapSequence=!1,i.hasValidFirstTap=!1)},100)}}}onMouseDown(e){this.mouseButtons.add(e.button),this.emit("mouseDown",{button:e.button,x:e.clientX,y:e.clientY})}onMouseUp(e){this.mouseButtons.delete(e.button),this.emit("mouseUp",{button:e.button,x:e.clientX,y:e.clientY})}onMouseMove(e){if(this.isPointerLocked)this.mouseDelta.x+=e.movementX,this.mouseDelta.y+=e.movementY;else{this.previousMousePosition.x=this.mousePosition.x,this.previousMousePosition.y=this.mousePosition.y,this.mousePosition.x=e.clientX,this.mousePosition.y=e.clientY;let t=this.mousePosition.x-this.previousMousePosition.x,i=this.mousePosition.y-this.previousMousePosition.y;this.mouseDelta.x+=t,this.mouseDelta.y+=i}this.emit("mouseMove",{x:this.mousePosition.x,y:this.mousePosition.y,deltaX:this.mouseDelta.x,deltaY:this.mouseDelta.y})}onWheel(e){this.emit("wheel",{deltaX:e.deltaX,deltaY:e.deltaY,deltaZ:e.deltaZ}),e.preventDefault()}onPointerLockChange(){this.isPointerLocked=null!==document.pointerLockElement}onPointerLockError(){this.isPointerLocked=!1}onWindowBlur(){this.keys.clear(),this.mouseButtons.clear(),this.keyTimings.clear()}onWindowFocus(){this.mouseDelta.x=0,this.mouseDelta.y=0}isGameKey(e){return["w","a","s","d"," ","shift","tab","escape"].includes(e)}destroy(){document.removeEventListener("keydown",this.onKeyDown.bind(this)),document.removeEventListener("keyup",this.onKeyUp.bind(this)),document.removeEventListener("mousedown",this.onMouseDown.bind(this)),document.removeEventListener("mouseup",this.onMouseUp.bind(this)),document.removeEventListener("mousemove",this.onMouseMove.bind(this)),document.removeEventListener("wheel",this.onWheel.bind(this)),document.removeEventListener("pointerlockchange",this.onPointerLockChange.bind(this)),document.removeEventListener("pointerlockerror",this.onPointerLockError.bind(this)),window.removeEventListener("blur",this.onWindowBlur.bind(this)),window.removeEventListener("focus",this.onWindowFocus.bind(this)),this.canvas&&(this.canvas.removeEventListener("mousedown",this.onMouseDown.bind(this)),this.canvas.removeEventListener("mouseup",this.onMouseUp.bind(this)),this.canvas.removeEventListener("mousemove",this.onMouseMove.bind(this)),this.canvas.removeEventListener("wheel",this.onWheel.bind(this))),this.keys.clear(),this.mouseButtons.clear(),this.keyTimings.clear(),this.removeAllListeners()}constructor(){super(),this.keys=new Set,this.mouseButtons=new Set,this.mousePosition={x:0,y:0},this.mouseDelta={x:0,y:0},this.previousMousePosition={x:0,y:0},this.isPointerLocked=!1,this.canvas=null,this.keyTimings=new Map,this.DOUBLE_TAP_THRESHOLD=200,this.setupEventListeners()}}class r extends a.v{async initialize(e){this.isInitialized||(this.canvas=e,this.inputManager.initialize(e),this.isInitialized=!0,this.emit("initialized"))}start(){if(!this.isInitialized)throw Error("Engine must be initialized before starting");this.isRunning||(this.isRunning=!0,this.gameLoop.start(),this.emit("started"))}stop(){this.isRunning&&(this.isRunning=!1,this.gameLoop.stop(),this.emit("stopped"))}pause(){this.isRunning&&(this.gameLoop.pause(),this.emit("paused"))}resume(){this.isRunning&&(this.gameLoop.resume(),this.emit("resumed"))}getWorld(){return this.world}getInputManager(){return this.inputManager}getCanvas(){return this.canvas}isEngineRunning(){return this.isRunning}getCurrentFPS(){return this.gameLoop.getCurrentFPS()}getPerformanceStats(){return{fps:this.gameLoop.getCurrentFPS(),frameTime:this.frameTime,updateTime:this.updateTime,renderTime:this.renderTime}}enableDebugMode(e){this.debugMode=e}isDebugMode(){return this.debugMode}setupGameLoop(){this.gameLoop.on("fixedUpdate",e=>{let{fixedDeltaTime:t}=e,i=performance.now();this.world.fixedUpdate(t),this.debugMode&&(this.updateTime=performance.now()-i)}),this.gameLoop.on("update",e=>{let{deltaTime:t}=e,i=performance.now();this.world.update(t),this.inputManager.update(),this.debugMode&&(this.updateTime=performance.now()-i),this.emit("update",{deltaTime:t})}),this.gameLoop.on("render",e=>{let{deltaTime:t,interpolation:i}=e,s=performance.now();this.world.render(t),this.debugMode&&(this.renderTime=performance.now()-s,this.frameTime=this.updateTime+this.renderTime),this.emit("render",{deltaTime:t,interpolation:i})})}destroy(){this.stop(),this.world.destroy(),this.inputManager.destroy(),this.removeAllListeners(),this.isInitialized=!1}requestPointerLock(){this.inputManager.requestPointerLock()}exitPointerLock(){this.inputManager.exitPointerLock()}isKeyPressed(e){return this.inputManager.isKeyPressed(e)}isMouseButtonPressed(e){return this.inputManager.isMouseButtonPressed(e)}getMouseDelta(){return this.inputManager.getMouseDelta()}constructor(e={}){super(),this.canvas=null,this.isInitialized=!1,this.isRunning=!1,this.debugMode=!1,this.frameTime=0,this.updateTime=0,this.renderTime=0,this.world=new s.q,this.gameLoop=new n,this.inputManager=new o,this.debugMode=e.enableDebug||!1,this.setupGameLoop()}}},3980:function(e,t,i){i.d(t,{J:function(){return s},w:function(){return a}});class s{addComponent(e){let t=e.componentType||e.constructor.name;return this.components.set(t,e),e}removeComponent(e){this.components.delete(e.name)}getComponent(e){let t=e.componentType||e.name,i=this.components.get(t);if(!i&&e.componentType&&(i=this.components.get(e.name)),!i){for(let[t,s]of Array.from(this.components.entries()))if(s instanceof e){i=s;break}}return i&&(i.componentType||i.constructor.name)!==t&&i.constructor.name.match(/^[a-z]$/),i}hasComponent(e){let t=e.componentType||e.name;if(this.components.has(t)||e.componentType&&this.components.has(e.name))return!0;for(let t of Array.from(this.components.values()))if(t instanceof e)return!0;return!1}hasComponents(e){return e.every(e=>this.hasComponent(e))}getAllComponents(){return Array.from(this.components.values())}getComponentNames(){return Array.from(this.components.keys())}isActive(){return this.active}setActive(e){this.active=e}destroy(){this.components.clear(),this.active=!1}constructor(){this.components=new Map,this.active=!0,this.id=s.nextId++}}s.nextId=1;class a{constructor(){this.enabled=!0}}},9131:function(e,t,i){i.d(t,{FU:function(){return n},Kg:function(){return a},xP:function(){return s}});class s{matchesEntity(e){return e.isActive()&&e.hasComponents(this.requiredComponents)}constructor(){this.enabled=!0,this.priority=0}}class a extends s{}class n extends s{}},4058:function(e,t,i){i.d(t,{q:function(){return o}});var s=i(3980),a=i(9131),n=i(6520);class o{createEntity(){let e=new s.J;return this.entities.set(e.id,e),e}destroyEntity(e){this.entitiesToDestroy.push(e)}notifyEntityAdded(e){for(let t of this.systems)t.onEntityAdded&&t.matchesEntity(e)&&t.onEntityAdded(e)}getEntity(e){return this.entities.get(e)}getAllEntities(){return Array.from(this.entities.values())}addSystem(e){var t;this.systems.push(e),this.systems.sort((e,t)=>e.priority-t.priority),e instanceof a.Kg&&this.renderSystems.push(e),e instanceof a.FU&&this.physicsSystems.push(e),null===(t=e.onEnable)||void 0===t||t.call(e)}getSystem(e){return this.systems.find(t=>t instanceof e)}removeSystem(e){let t=this.systems.findIndex(t=>t instanceof e);if(-1!==t){var i;let e=this.systems[t];null===(i=e.onDisable)||void 0===i||i.call(e),this.systems.splice(t,1);let s=this.renderSystems.findIndex(t=>t===e);-1!==s&&this.renderSystems.splice(s,1);let a=this.physicsSystems.findIndex(t=>t===e);-1!==a&&this.physicsSystems.splice(a,1)}}createComponent(e){let t=e.componentType||e.name;if(["Health","HealthBar","Transform","Movement","Collider","Renderer","Enemy","Projectile","Animation"].includes(t))return new e;let i=this.componentPools.get(t);return i||(i=new n.L(()=>new e,e=>e.reset(),100),this.componentPools.set(t,i)),i.acquire()}returnComponent(e){let t=this.componentPools.get(e.constructor.name);t&&t.release(e)}update(e){for(let t of(this.cleanupDestroyedEntities(),this.systems)){if(!t.enabled)continue;let i=this.getEntitiesForSystem(t);t.update(i,e)}}fixedUpdate(e){for(let t of this.physicsSystems){if(!t.enabled)continue;let i=this.getEntitiesForSystem(t);t.fixedUpdate(i,e)}}render(e){for(let t of this.renderSystems){if(!t.enabled)continue;let i=this.getEntitiesForSystem(t);t.render(i,e)}}getEntitiesForSystem(e){let t=[];for(let i of Array.from(this.entities.values()))e.matchesEntity(i)&&t.push(i);return t}cleanupDestroyedEntities(){for(let e of this.entitiesToDestroy){let t=this.entities.get(e);if(t){for(let e of this.systems)e.onEntityRemoved&&e.matchesEntity(t)&&e.onEntityRemoved(t);for(let e of t.getAllComponents())this.returnComponent(e);t.destroy(),this.entities.delete(e)}}this.entitiesToDestroy.length=0}queryEntities(e){let t=[];for(let i of Array.from(this.entities.values()))i.isActive()&&i.hasComponents(e)&&t.push(i);return t}emitEvent(e,t){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)}getEvents(e){return this.events.get(e)||[]}clearEvents(e){this.events.set(e,[])}destroy(){for(let e of Array.from(this.entities.values()))e.destroy();for(let t of(this.entities.clear(),this.systems)){var e;null===(e=t.onDisable)||void 0===e||e.call(t)}this.systems.length=0,this.renderSystems.length=0,this.physicsSystems.length=0,this.componentPools.clear(),this.events.clear()}constructor(){this.entities=new Map,this.systems=[],this.renderSystems=[],this.physicsSystems=[],this.componentPools=new Map,this.entitiesToDestroy=[],this.events=new Map}}},3478:function(e,t,i){i.d(t,{F5:function(){return n},YM:function(){return l},aB:function(){return o}});var s,a,n,o,r=i(1448),h=i(3980);(s=n||(n={})).SPHERE="sphere",s.BOX="box",s.CAPSULE="capsule",s.CYLINDER="cylinder",(a=o||(o={}))[a.DEFAULT=1]="DEFAULT",a[a.PLAYER=2]="PLAYER",a[a.ENEMY=4]="ENEMY",a[a.PROJECTILE=8]="PROJECTILE",a[a.ENVIRONMENT=16]="ENVIRONMENT",a[a.PICKUP=32]="PICKUP";class l extends h.w{getDefaultMask(e){switch(e){case 2:return 52;case 4:return 26;case 8:return 22;case 16:return 14;case 32:return 2;default:return 4294967295}}static createSphere(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return new l("sphere",e,t)}static createBox(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=new l("box",0,t);return i.size.copy(e),i}static createCapsule(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=new l("capsule",e,i);return s.height=t,s}static createCylinder(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=new l("cylinder",e,i);return s.height=t,s}setOffset(e,t,i){this.offset.set(e,t,i),this.boundsNeedUpdate=!0}setLayer(e){this.layer=e,this.mask=this.getDefaultMask(e)}setMask(e){this.mask=e}canCollideWith(e){return(this.mask&e.layer)!=0&&(e.mask&this.layer)!=0}updateBounds(e){if(!this.boundsNeedUpdate&&!this.isStatic)return;let t=e.clone().add(this.offset);switch(this.type){case"sphere":this.boundingSphere.set(t,this.radius),this.bounds.setFromCenterAndSize(t,new r.Vector3(2*this.radius,2*this.radius,2*this.radius));break;case"box":this.bounds.setFromCenterAndSize(t,this.size),this.boundingSphere.setFromPoints([t.clone().add(new r.Vector3(-this.size.x/2,-this.size.y/2,-this.size.z/2)),t.clone().add(new r.Vector3(this.size.x/2,this.size.y/2,this.size.z/2))]);break;case"capsule":let i=Math.max(this.radius,this.size.x/2,this.size.z/2);this.boundingSphere.set(t,Math.max(i,this.height/2)),this.bounds.setFromCenterAndSize(t,new r.Vector3(2*i,this.height,2*i));break;case"cylinder":this.boundingSphere.set(t,Math.max(this.radius,this.height/2)),this.bounds.setFromCenterAndSize(t,new r.Vector3(2*this.radius,this.height,2*this.radius))}this.boundsNeedUpdate=!1}intersects(e,t,i){return this.updateBounds(t),e.updateBounds(i),!!this.boundingSphere.intersectsSphere(e.boundingSphere)&&this.preciseIntersection(e,t,i)}preciseIntersection(e,t,i){let s=t.clone().add(this.offset),a=i.clone().add(e.offset);if("sphere"===this.type&&"sphere"===e.type)return s.distanceTo(a)<=this.radius+e.radius;if("box"===this.type&&"box"===e.type)return this.bounds.intersectsBox(e.bounds);if("sphere"===this.type&&"box"===e.type||"box"===this.type&&"sphere"===e.type){let t="sphere"===this.type?this:e,i="box"===this.type?this:e,n="sphere"===this.type?s:a,o=new r.Vector3;return i.bounds.clampPoint(n,o),n.distanceTo(o)<=t.radius}if("sphere"===this.type&&"cylinder"===e.type||"cylinder"===this.type&&"sphere"===e.type){let t="sphere"===this.type?this:e,i="cylinder"===this.type?this:e,n="sphere"===this.type?s:a,o="cylinder"===this.type?s:a;return!(Math.abs(n.y-o.y)>i.height/2+t.radius)&&Math.sqrt(Math.pow(n.x-o.x,2)+Math.pow(n.z-o.z,2))<=t.radius+i.radius}return this.bounds.intersectsBox(e.bounds)}getClosestPoint(e,t){this.updateBounds(t);let i=t.clone().add(this.offset);switch(this.type){case"sphere":let s=e.clone().sub(i).normalize();return i.clone().add(s.multiplyScalar(this.radius));case"box":let a=new r.Vector3;return this.bounds.clampPoint(e,a),a;default:let n=new r.Vector3;return this.bounds.clampPoint(e,n),n}}getVolume(){switch(this.type){case"sphere":return 4/3*Math.PI*Math.pow(this.radius,3);case"box":return this.size.x*this.size.y*this.size.z;case"cylinder":return Math.PI*Math.pow(this.radius,2)*this.height;case"capsule":return 4/3*Math.PI*Math.pow(this.radius,3)+Math.PI*Math.pow(this.radius,2)*(this.height-2*this.radius);default:return 1}}reset(){this.type="sphere",this.radius=.5,this.size.set(1,1,1),this.height=2,this.offset.set(0,0,0),this.layer=1,this.mask=this.getDefaultMask(1),this.isTrigger=!1,this.isStatic=!1,this.bounds=new r.Box3,this.boundingSphere=new r.Sphere,this.boundsNeedUpdate=!0,this.onCollisionEnter=void 0,this.onCollisionStay=void 0,this.onCollisionExit=void 0,this.onTriggerEnter=void 0,this.onTriggerStay=void 0,this.onTriggerExit=void 0,this.enabled=!0}clone(){let e=new l(this.type,this.radius,this.layer);return e.size.copy(this.size),e.height=this.height,e.offset.copy(this.offset),e.mask=this.mask,e.isTrigger=this.isTrigger,e.isStatic=this.isStatic,e}constructor(e="sphere",t=.5,i=1){super(),this.componentType="Collider",this.type=e,this.radius=t,this.size=new r.Vector3(1,1,1),this.height=2,this.offset=new r.Vector3(0,0,0),this.layer=i,this.mask=this.getDefaultMask(i),this.isTrigger=!1,this.isStatic=!1,this.bounds=new r.Box3,this.boundingSphere=new r.Sphere,this.boundsNeedUpdate=!0}}l.componentType="Collider"},8001:function(e,t,i){i.d(t,{C:function(){return o},Z:function(){return a}});var s,a,n=i(3980);(s=a||(a={})).DUMMY="dummy",s.GRUNT="grunt",s.ELITE="elite",s.BOSS="boss";class o extends n.w{calculateExperienceReward(){return({dummy:5,grunt:10,elite:25,boss:100})[this.type]*this.level}calculateAggroRange(){return({dummy:0,grunt:5,elite:8,boss:12})[this.type]}calculateAttackRange(){return({dummy:0,grunt:1.5,elite:2,boss:3})[this.type]}calculateAttackDamage(){return({dummy:0,grunt:15,elite:25,boss:50})[this.type]*this.level}calculateAttackCooldown(){return({dummy:0,grunt:2,elite:1.5,boss:1})[this.type]}calculateMovementSpeed(){return({dummy:0,grunt:3,elite:0,boss:2.5})[this.type]}canAttack(e){return!!this.isAggressive&&!this.isDead&&0!==this.attackDamage&&e-this.lastAttackTime>=this.attackCooldown}performAttack(e){this.lastAttackTime=e}takeDamage(){}die(e){this.isDead=!0,this.deathTime=e}canRespawnNow(e){return!!this.canRespawn&&!!this.isDead&&e-this.deathTime>=this.respawnTime}respawn(){this.isDead=!1,this.deathTime=0,this.lastAttackTime=0,this.unfreeze(),this.removeVenom()}freeze(e,t){this.isDead||(this.isFrozen=!0,this.freezeStartTime=t,this.freezeDuration=e,this.movementSpeed=0)}unfreeze(){this.isFrozen=!1,this.freezeStartTime=0,this.freezeDuration=0,this.movementSpeed=this.originalMovementSpeed}updateFreezeStatus(e){this.isFrozen&&e-this.freezeStartTime>=this.freezeDuration&&this.unfreeze()}canMove(){return!this.isFrozen&&!this.isDead}applyVenom(e,t,i){this.isDead||(this.isVenomous=!0,this.venomStartTime=i,this.venomDuration=e,this.venomDamagePerSecond=t,this.lastVenomDamageTime=i)}removeVenom(){this.isVenomous=!1,this.venomStartTime=0,this.venomDuration=0,this.venomDamagePerSecond=0,this.lastVenomDamageTime=0}updateVenomStatus(e){return this.isVenomous?e-this.venomStartTime>=this.venomDuration?(this.removeVenom(),{shouldDealDamage:!1,damage:0}):e-this.lastVenomDamageTime>=1?(this.lastVenomDamageTime=e,{shouldDealDamage:!0,damage:this.venomDamagePerSecond}):{shouldDealDamage:!1,damage:0}:{shouldDealDamage:!1,damage:0}}setLevel(e){this.level=Math.max(1,e),this.experienceReward=this.calculateExperienceReward(),this.attackDamage=this.calculateAttackDamage()}getDisplayName(){return"".concat({dummy:"Training Dummy",grunt:"Grunt",elite:"Elite",boss:"Boss"}[this.type]," (Lv.").concat(this.level,")")}reset(){this.type="dummy",this.level=1,this.experienceReward=this.calculateExperienceReward(),this.isAggressive=!1,this.aggroRange=this.calculateAggroRange(),this.attackRange=this.calculateAttackRange(),this.attackDamage=this.calculateAttackDamage(),this.attackCooldown=this.calculateAttackCooldown(),this.lastAttackTime=0,this.movementSpeed=this.calculateMovementSpeed(),this.isDead=!1,this.deathTime=0,this.respawnTime=30,this.canRespawn=!0,this.enabled=!0,this.isFrozen=!1,this.freezeStartTime=0,this.freezeDuration=0,this.originalMovementSpeed=this.movementSpeed,this.isVenomous=!1,this.venomStartTime=0,this.venomDuration=0,this.venomDamagePerSecond=0,this.lastVenomDamageTime=0}clone(){let e=new o(this.type,this.level);return e.experienceReward=this.experienceReward,e.isAggressive=this.isAggressive,e.aggroRange=this.aggroRange,e.attackRange=this.attackRange,e.attackDamage=this.attackDamage,e.attackCooldown=this.attackCooldown,e.lastAttackTime=this.lastAttackTime,e.movementSpeed=this.movementSpeed,e.isDead=this.isDead,e.deathTime=this.deathTime,e.respawnTime=this.respawnTime,e.canRespawn=this.canRespawn,e.isFrozen=this.isFrozen,e.freezeStartTime=this.freezeStartTime,e.freezeDuration=this.freezeDuration,e.originalMovementSpeed=this.originalMovementSpeed,e.isVenomous=this.isVenomous,e.venomStartTime=this.venomStartTime,e.venomDuration=this.venomDuration,e.venomDamagePerSecond=this.venomDamagePerSecond,e.lastVenomDamageTime=this.lastVenomDamageTime,e}constructor(e="dummy",t=1){super(),this.componentType="Enemy",this.type=e,this.level=t,this.experienceReward=this.calculateExperienceReward(),this.isAggressive="dummy"!==e,this.aggroRange=this.calculateAggroRange(),this.attackRange=this.calculateAttackRange(),this.attackDamage=this.calculateAttackDamage(),this.attackCooldown=this.calculateAttackCooldown(),this.lastAttackTime=0,this.movementSpeed=this.calculateMovementSpeed(),this.isDead=!1,this.deathTime=0,this.respawnTime=30,this.canRespawn=!0,this.isFrozen=!1,this.freezeStartTime=0,this.freezeDuration=0,this.originalMovementSpeed=this.movementSpeed,this.isVenomous=!1,this.venomStartTime=0,this.venomDuration=0,this.venomDamagePerSecond=0,this.lastVenomDamageTime=0}}o.componentType="Enemy"},6862:function(e,t,i){i.d(t,{S:function(){return n}});var s=i(3980),a=i(3974);class n extends s.w{takeDamage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Date.now()/1e3,i=arguments.length>2?arguments[2]:void 0,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(this.isDead||!s&&this.isInvulnerable||e<=0)return!1;let n=e;if(i){let t=i.getComponent(a.W);t&&(n=t.absorbDamage(e))}return n>0&&(this.currentHealth=Math.max(0,this.currentHealth-n),this.lastDamageTime=t,this.isInvulnerable=!0,this.invulnerabilityTimer=this.invulnerabilityDuration,this.currentHealth<=0&&(this.isDead=!0)),!0}heal(e){if(this.isDead||e<=0)return!1;let t=this.currentHealth;return this.currentHealth=Math.min(this.maxHealth,this.currentHealth+e),this.currentHealth>t}setMaxHealth(e){let t=this.getHealthRatio();this.maxHealth=Math.max(1,e),this.currentHealth=Math.floor(this.maxHealth*t)}getHealthRatio(){return this.maxHealth>0?this.currentHealth/this.maxHealth:0}getHealthPercentage(){return 100*this.getHealthRatio()}isFullHealth(){return this.currentHealth>=this.maxHealth}isLowHealth(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.25;return this.getHealthRatio()<=e}isCriticalHealth(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1;return this.getHealthRatio()<=e}revive(e){this.isDead=!1,this.currentHealth=void 0!==e?Math.min(this.maxHealth,e):this.maxHealth,this.isInvulnerable=!1,this.invulnerabilityTimer=0}update(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Date.now()/1e3;this.isInvulnerable&&(this.invulnerabilityTimer-=e,this.invulnerabilityTimer<=0&&(this.isInvulnerable=!1,this.invulnerabilityTimer=0)),this.canRegenerate&&!this.isDead&&!this.isFullHealth()&&t-this.lastDamageTime>=this.regenerationDelay&&this.heal(this.regenerationRate*e)}setInvulnerable(e){this.isInvulnerable=!0,this.invulnerabilityTimer=e}removeInvulnerability(){this.isInvulnerable=!1,this.invulnerabilityTimer=0}enableRegeneration(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;this.canRegenerate=!0,this.regenerationRate=e,this.regenerationDelay=t}disableRegeneration(){this.canRegenerate=!1}reset(){this.currentHealth=this.maxHealth,this.isInvulnerable=!1,this.invulnerabilityTimer=0,this.isDead=!1,this.canRegenerate=!1,this.regenerationRate=5,this.regenerationDelay=3,this.lastDamageTime=0,this.enabled=!0}clone(){let e=new n(this.maxHealth);return e.currentHealth=this.currentHealth,e.isInvulnerable=this.isInvulnerable,e.invulnerabilityDuration=this.invulnerabilityDuration,e.invulnerabilityTimer=this.invulnerabilityTimer,e.isDead=this.isDead,e.canRegenerate=this.canRegenerate,e.regenerationRate=this.regenerationRate,e.regenerationDelay=this.regenerationDelay,e.lastDamageTime=this.lastDamageTime,e}constructor(e=100){super(),this.componentType="Health",this.maxHealth=e,this.currentHealth=e,this.isInvulnerable=!1,this.invulnerabilityDuration=.5,this.invulnerabilityTimer=0,this.isDead=!1,this.canRegenerate=!1,this.regenerationRate=5,this.regenerationDelay=3,this.lastDamageTime=0}}n.componentType="Health"},6776:function(e,t,i){i.d(t,{T:function(){return n}});var s=i(1448),a=i(3980);class n extends a.w{createHealthBarMeshes(){this.group=new s.Group;let e=new s.PlaneGeometry(this.width+2*this.borderWidth,this.height+2*this.borderWidth),t=new s.MeshBasicMaterial({color:this.borderColor,transparent:!0,opacity:.8});this.borderMesh=new s.Mesh(e,t),this.borderMesh.position.z=-.001,this.group.add(this.borderMesh);let i=new s.PlaneGeometry(this.width,this.height),a=new s.MeshBasicMaterial({color:this.backgroundColor,transparent:!0,opacity:.7});this.backgroundMesh=new s.Mesh(i,a),this.group.add(this.backgroundMesh);let n=new s.PlaneGeometry(this.width,this.height),o=new s.MeshBasicMaterial({color:this.healthColor,transparent:!0,opacity:.9});this.healthMesh=new s.Mesh(n,o),this.healthMesh.position.z=.001,this.group.add(this.healthMesh),this.group.lookAt(0,0,1)}updateHealthBar(e,t,i,a){this.currentHealthRatio=Math.max(0,Math.min(1,e)),Math.abs(this.lastHealthRatio-this.currentHealthRatio)>.01?this.lastHealthRatio=s.MathUtils.lerp(this.lastHealthRatio,this.currentHealthRatio,this.animationSpeed*a):this.lastHealthRatio=this.currentHealthRatio,this.updateHealthMesh(),this.updateHealthColor(),this.updateVisibility(t,i),this.updatePositionAndRotation(t,i),this.updateDamageFlash(a)}updateHealthMesh(){this.healthMesh.scale.x=this.lastHealthRatio;let e=this.width*(1-this.lastHealthRatio)/2;this.healthMesh.position.x=-e}updateHealthColor(){let e;if(this.currentHealthRatio<=this.criticalHealthThreshold)e=this.criticalHealthColor;else if(this.currentHealthRatio<=this.lowHealthThreshold){let t=(this.currentHealthRatio-this.criticalHealthThreshold)/(this.lowHealthThreshold-this.criticalHealthThreshold);e=new s.Color().lerpColors(this.criticalHealthColor,this.lowHealthColor,t)}else{let t=(this.currentHealthRatio-this.lowHealthThreshold)/(1-this.lowHealthThreshold);e=new s.Color().lerpColors(this.lowHealthColor,this.healthColor,t)}this.healthMesh.material.color.copy(e)}updateVisibility(e,t){let i=e.distanceTo(t),s=i<=this.fadeDistance;if(!this.showWhenFull&&this.currentHealthRatio>=.99&&(s=!1),this.isVisible=s,this.group.visible=this.isVisible,this.isVisible&&i>.7*this.fadeDistance){let e=Math.max(.1,1-(i-.7*this.fadeDistance)/(.3*this.fadeDistance));this.backgroundMesh.material.opacity=.7*e,this.healthMesh.material.opacity=.9*e,this.borderMesh.material.opacity=.8*e}else this.isVisible&&(this.backgroundMesh.material.opacity=.7,this.healthMesh.material.opacity=.9,this.borderMesh.material.opacity=.8)}updatePositionAndRotation(e,t){let i=t.clone().add(this.offset);this.group.position.copy(i),this.group.lookAt(e)}updateDamageFlash(e){if(this.damageFlashTimer>0){this.damageFlashTimer-=e;let t=this.damageFlashTimer/this.damageFlashDuration,i=new s.Color(1,1,1),a=this.healthMesh.material.color.clone();a.lerp(i,.5*t),this.healthMesh.material.color.copy(a)}}triggerDamageFlash(){this.damageFlashTimer=this.damageFlashDuration}setHealthRatio(e){let t=this.currentHealthRatio;this.currentHealthRatio=Math.max(0,Math.min(1,e)),this.currentHealthRatio<t&&this.triggerDamageFlash()}getGroup(){return this.group}dispose(){this.backgroundMesh.geometry.dispose(),this.backgroundMesh.material.dispose(),this.healthMesh.geometry.dispose(),this.healthMesh.material.dispose(),this.borderMesh.geometry.dispose(),this.borderMesh.material.dispose(),this.group.parent&&this.group.parent.remove(this.group)}reset(){this.currentHealthRatio=1,this.lastHealthRatio=1,this.isVisible=!0,this.damageFlashTimer=0,this.enabled=!0,this.updateHealthMesh(),this.updateHealthColor()}clone(){return new n({width:this.width,height:this.height,offset:this.offset.clone(),backgroundColor:this.backgroundColor.clone(),healthColor:this.healthColor.clone(),lowHealthColor:this.lowHealthColor.clone(),criticalHealthColor:this.criticalHealthColor.clone(),borderColor:this.borderColor.clone(),borderWidth:this.borderWidth,showWhenFull:this.showWhenFull,fadeDistance:this.fadeDistance,lowHealthThreshold:this.lowHealthThreshold,criticalHealthThreshold:this.criticalHealthThreshold})}constructor(e={}){var t,i,a,n,o,r;super(),this.componentType="HealthBar",this.width=e.width||1,this.height=e.height||.1,this.offset=(null===(t=e.offset)||void 0===t?void 0:t.clone())||new s.Vector3(0,1.5,0),this.backgroundColor=(null===(i=e.backgroundColor)||void 0===i?void 0:i.clone())||new s.Color(3355443),this.healthColor=(null===(a=e.healthColor)||void 0===a?void 0:a.clone())||new s.Color(65280),this.lowHealthColor=(null===(n=e.lowHealthColor)||void 0===n?void 0:n.clone())||new s.Color(16776960),this.criticalHealthColor=(null===(o=e.criticalHealthColor)||void 0===o?void 0:o.clone())||new s.Color(16711680),this.borderColor=(null===(r=e.borderColor)||void 0===r?void 0:r.clone())||new s.Color(0),this.borderWidth=e.borderWidth||.02,this.showWhenFull=void 0!==e.showWhenFull&&e.showWhenFull,this.fadeDistance=e.fadeDistance||20,this.lowHealthThreshold=e.lowHealthThreshold||.5,this.criticalHealthThreshold=e.criticalHealthThreshold||.25,this.isVisible=!0,this.currentHealthRatio=1,this.lastHealthRatio=1,this.animationSpeed=5,this.damageFlashTimer=0,this.damageFlashDuration=.2,this.createHealthBarMeshes()}}n.componentType="HealthBar"},7771:function(e,t,i){i.d(t,{i:function(){return n}});var s=i(1448),a=i(3980);class n extends a.w{addForce(e){this.acceleration.add(e)}addImpulse(e){this.velocity.add(e)}jump(){this.canJump&&(this.isGrounded||this.canFly)&&(this.velocity.y=this.jumpForce,this.isGrounded=!1)}setMoveDirection(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this.moveDirection.copy(e).normalize(),this.inputStrength=Math.max(0,Math.min(1,t))}freeze(e){let t=Date.now();this.isFrozen=!0,this.frozenUntil=t+e}slow(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=Date.now();this.isSlowed=!0,this.slowedUntil=i+e,this.movementSpeedMultiplier=t}updateDebuffs(){let e=Date.now();this.isFrozen&&e>=this.frozenUntil&&(this.isFrozen=!1,this.frozenUntil=0,console.log("\uD83E\uDDCA Player unfrozen")),this.isSlowed&&e>=this.slowedUntil&&(this.isSlowed=!1,this.slowedUntil=0,this.movementSpeedMultiplier=1,console.log("\uD83D\uDC0C Player no longer slowed"))}getEffectiveMaxSpeed(){return this.isFrozen?0:this.maxSpeed*this.movementSpeedMultiplier}startDash(e,t,i){if(this.isDashing)return!1;let s=this.dashCharges.findIndex(e=>e.isAvailable);return -1!==s&&(this.isDashing=!0,this.dashDirection.copy(e).normalize(),this.dashStartTime=i,this.dashStartPosition.copy(t),this.dashCharges[s].isAvailable=!1,this.dashCharges[s].cooldownStartTime=i,setTimeout(()=>{this.dashCharges[s].isAvailable=!0,this.dashCharges[s].cooldownStartTime=null},6e3),!0)}updateDash(e){if(!this.isDashing)return{isComplete:!1,newPosition:null};let t=Math.min((e-this.dashStartTime)/this.dashDuration,1);if(t>=1)return this.isDashing=!1,{isComplete:!0,newPosition:this.dashStartPosition.clone().add(this.dashDirection.clone().multiplyScalar(this.dashDistance))};let i=this.dashDirection.clone().multiplyScalar(this.dashDistance*(1-Math.pow(1-t,2)));return{isComplete:!1,newPosition:this.dashStartPosition.clone().add(i)}}cancelDash(){this.isDashing=!1,this.dashDirection.set(0,0,0),this.dashStartTime=0}stop(){this.velocity.set(0,0,0),this.acceleration.set(0,0,0),this.moveDirection.set(0,0,0),this.inputStrength=0}getSpeed(){return this.velocity.length()}getHorizontalSpeed(){return Math.sqrt(this.velocity.x*this.velocity.x+this.velocity.z*this.velocity.z)}isMoving(){return this.getSpeed()>.01}isMovingHorizontally(){return this.getHorizontalSpeed()>.01}isFalling(){return this.velocity.y<-.1}isRising(){return this.velocity.y>.1}getAvailableDashCharges(){return this.dashCharges.filter(e=>e.isAvailable).length}getDashChargeStatus(){let e=Date.now()/1e3;return this.dashCharges.map(t=>({isAvailable:t.isAvailable,cooldownRemaining:t.cooldownStartTime?Math.max(0,6-(e-t.cooldownStartTime)):0}))}startCharge(e,t,i){return!this.isCharging&&!this.isDashing&&(this.isCharging=!0,this.chargeDirection.copy(e).normalize(),this.chargeStartTime=i,this.chargeStartPosition.copy(t),!0)}updateCharge(e){if(!this.isCharging)return{isComplete:!1,newPosition:null};let t=Math.min((e-this.chargeStartTime)/this.chargeDuration,1);if(t>=1)return this.isCharging=!1,{isComplete:!0,newPosition:this.chargeStartPosition.clone().add(this.chargeDirection.clone().multiplyScalar(this.chargeDistance))};let i=this.chargeDirection.clone().multiplyScalar(this.chargeDistance*(1-Math.pow(1-t,2)));return{isComplete:!1,newPosition:this.chargeStartPosition.clone().add(i)}}cancelCharge(){this.isCharging=!1,this.chargeDirection.set(0,0,0),this.chargeStartTime=0}clampVelocity(){let e=this.getEffectiveMaxSpeed(),t=new s.Vector3(this.velocity.x,0,this.velocity.z);t.length()>e&&(0===e?(this.velocity.x=0,this.velocity.z=0):(t.normalize().multiplyScalar(e),this.velocity.x=t.x,this.velocity.z=t.z))}applyFriction(e){if(!this.canMove)return;let t=Math.pow(this.friction,e);this.velocity.x*=t,this.velocity.z*=t,.01>Math.abs(this.velocity.x)&&(this.velocity.x=0),.01>Math.abs(this.velocity.z)&&(this.velocity.z=0)}applyGravity(e){this.canFly||(this.velocity.y+=this.gravity*e)}reset(){this.velocity?this.velocity.set(0,0,0):this.velocity=new s.Vector3(0,0,0),this.acceleration?this.acceleration.set(0,0,0):this.acceleration=new s.Vector3(0,0,0),this.moveDirection?this.moveDirection.set(0,0,0):this.moveDirection=new s.Vector3(0,0,0),this.inputStrength=0,this.isGrounded=!1,this.canMove=!0,this.canJump=!0,this.canFly=!1,this.maxSpeed=5,this.friction=.8,this.jumpForce=20,this.gravity=-12.5,this.enabled=!0,this.isFrozen=!1,this.frozenUntil=0,this.isSlowed=!1,this.slowedUntil=0,this.movementSpeedMultiplier=1,this.isDashing=!1,this.dashDirection.set(0,0,0),this.dashStartTime=0,this.dashDuration=.35,this.dashDistance=4,this.dashStartPosition.set(0,0,0),this.maxDashCharges=3,this.dashCharges=Array.from({length:this.maxDashCharges},()=>({isAvailable:!0,cooldownStartTime:null})),this.isCharging=!1,this.chargeDirection.set(0,0,0),this.chargeStartTime=0,this.chargeDuration=.35,this.chargeDistance=9,this.chargeStartPosition.set(0,0,0)}clone(){let e=new n(this.maxSpeed,this.friction,this.jumpForce,this.gravity);return e.velocity.copy(this.velocity),e.acceleration.copy(this.acceleration),e.moveDirection.copy(this.moveDirection),e.inputStrength=this.inputStrength,e.isGrounded=this.isGrounded,e.canMove=this.canMove,e.canJump=this.canJump,e.canFly=this.canFly,e.isFrozen=this.isFrozen,e.frozenUntil=this.frozenUntil,e.isSlowed=this.isSlowed,e.slowedUntil=this.slowedUntil,e.movementSpeedMultiplier=this.movementSpeedMultiplier,e.isDashing=this.isDashing,e.dashDirection.copy(this.dashDirection),e.dashStartTime=this.dashStartTime,e.dashDuration=this.dashDuration,e.dashDistance=this.dashDistance,e.dashStartPosition.copy(this.dashStartPosition),e.maxDashCharges=this.maxDashCharges,e.dashCharges=this.dashCharges.map(e=>({isAvailable:e.isAvailable,cooldownStartTime:e.cooldownStartTime})),e.isCharging=this.isCharging,e.chargeDirection.copy(this.chargeDirection),e.chargeStartTime=this.chargeStartTime,e.chargeDuration=this.chargeDuration,e.chargeDistance=this.chargeDistance,e.chargeStartPosition.copy(this.chargeStartPosition),e}constructor(e=3.75,t=.8,i=20,a=-12.5){super(),this.componentType="Movement",this.velocity=new s.Vector3(0,0,0),this.acceleration=new s.Vector3(0,0,0),this.maxSpeed=e,this.friction=t,this.isGrounded=!1,this.jumpForce=i,this.gravity=a,this.canMove=!0,this.canJump=!0,this.canFly=!1,this.isFrozen=!1,this.frozenUntil=0,this.isSlowed=!1,this.slowedUntil=0,this.movementSpeedMultiplier=1,this.moveDirection=new s.Vector3(0,0,0),this.inputStrength=0,this.isDashing=!1,this.dashDirection=new s.Vector3(0,0,0),this.dashStartTime=0,this.dashDuration=.35,this.dashDistance=4,this.dashStartPosition=new s.Vector3(0,0,0),this.maxDashCharges=3,this.dashCharges=Array.from({length:this.maxDashCharges},()=>({isAvailable:!0,cooldownStartTime:null})),this.isCharging=!1,this.chargeDirection=new s.Vector3(0,0,0),this.chargeStartTime=0,this.chargeDuration=.35,this.chargeDistance=9,this.chargeStartPosition=new s.Vector3(0,0,0)}}n.componentType="Movement"},1168:function(e,t,i){i.d(t,{W:function(){return n}});var s=i(1448),a=i(3980);class n extends a.w{setDirection(e){this.velocity.copy(e).normalize().multiplyScalar(this.speed)}addGravity(e){this.gravity=e}setPiercing(e){this.piercing=e}setExplosive(e){this.explosionRadius=e}setBouncing(e){this.maxBounces=e}setMaxDistance(e){this.maxDistance=e}setStartPosition(e){this.startPosition.copy(e)}hasHitTarget(e){return this.hitTargets.has(e)}addHitTarget(e){this.hitTargets.add(e)}canHitTarget(e){return e!==this.owner&&(!!this.piercing||!this.hasHitTarget(e))}isExpired(){return this.lifetime>=this.maxLifetime||this.distanceTraveled>=this.maxDistance}canBounce(){return this.bounces<this.maxBounces}bounce(e){if(!this.canBounce())return;let t=this.velocity.clone().reflect(e);this.velocity.copy(t),this.bounces++}update(e){this.lifetime+=e;let t=this.velocity.length()*e;this.distanceTraveled+=t,0!==this.gravity&&(this.velocity.y+=this.gravity*e)}getPosition(e){return e.clone()}getPredictedPosition(e,t){let i=e.clone();return i.add(this.velocity.clone().multiplyScalar(t)),i}reset(){this.velocity.set(0,0,0),this.speed=20,this.damage=10,this.lifetime=0,this.maxLifetime=5,this.piercing=!1,this.hitTargets.clear(),this.explosionRadius=0,this.gravity=0,this.bounces=0,this.maxBounces=0,this.owner=-1,this.distanceTraveled=0,this.maxDistance=1/0,this.startPosition.set(0,0,0),this.enabled=!0}clone(){let e=new n(this.speed,this.damage,this.maxLifetime,this.owner);return e.velocity.copy(this.velocity),e.lifetime=this.lifetime,e.piercing=this.piercing,e.hitTargets=new Set(this.hitTargets),e.explosionRadius=this.explosionRadius,e.gravity=this.gravity,e.bounces=this.bounces,e.maxBounces=this.maxBounces,e.distanceTraveled=this.distanceTraveled,e.maxDistance=this.maxDistance,e.startPosition.copy(this.startPosition),e}constructor(e=20,t=10,i=5,a=-1){super(),this.componentType="Projectile",this.velocity=new s.Vector3(0,0,0),this.speed=e,this.damage=t,this.lifetime=0,this.maxLifetime=i,this.piercing=!1,this.hitTargets=new Set,this.explosionRadius=0,this.gravity=0,this.bounces=0,this.maxBounces=0,this.owner=a,this.distanceTraveled=0,this.maxDistance=1/0,this.startPosition=new s.Vector3(0,0,0)}}n.componentType="Projectile"},246:function(e,t,i){i.d(t,{T:function(){return n}});var s=i(1448),a=i(3980);class n extends a.w{setGeometry(e){this.geometry&&this.geometry!==e&&this.geometry.dispose(),this.geometry=e,this.needsUpdate=!0}setMaterial(e){this.material&&this.material!==e&&(Array.isArray(this.material)?this.material.forEach(e=>e.dispose()):this.material.dispose()),this.material=e,this.needsUpdate=!0}createMesh(){return this.geometry&&this.material?(this.mesh&&this.disposeMesh(),this.mesh=new s.Mesh(this.geometry,this.material),this.mesh.castShadow=this.castShadow,this.mesh.receiveShadow=this.receiveShadow,this.mesh.frustumCulled=this.frustumCulled,this.mesh.visible=this.visible,this.mesh.renderOrder=this.renderOrder,this.needsUpdate=!1,this.mesh):null}updateMesh(){this.mesh&&(this.mesh instanceof s.Mesh?(this.mesh.castShadow=this.castShadow,this.mesh.receiveShadow=this.receiveShadow):this.mesh instanceof s.Group&&this.mesh.traverse(e=>{e instanceof s.Mesh&&(e.castShadow=this.castShadow,e.receiveShadow=this.receiveShadow)}),this.mesh.frustumCulled=this.frustumCulled,this.mesh.visible=this.visible,this.mesh.renderOrder=this.renderOrder,this.needsUpdate&&this.geometry&&this.material&&this.mesh instanceof s.Mesh&&(this.mesh.geometry=this.geometry,this.mesh.material=this.material,this.needsUpdate=!1))}setVisible(e){this.visible=e,this.mesh&&(this.mesh.visible=e)}setCastShadow(e){this.castShadow=e,this.mesh instanceof s.Mesh?this.mesh.castShadow=e:this.mesh instanceof s.Group&&this.mesh.traverse(t=>{t instanceof s.Mesh&&(t.castShadow=e)})}setReceiveShadow(e){this.receiveShadow=e,this.mesh instanceof s.Mesh?this.mesh.receiveShadow=e:this.mesh instanceof s.Group&&this.mesh.traverse(t=>{t instanceof s.Mesh&&(t.receiveShadow=e)})}setupAnimations(e){this.mesh&&(this.animations=e,e.length>0&&(this.animationMixer=new s.AnimationMixer(this.mesh)))}playAnimation(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.2;if(!this.animationMixer)return null;let a=this.animations.find(t=>t.name===e);if(!a)return null;this.currentAnimation&&this.currentAnimation.fadeOut(i);let n=this.animationMixer.clipAction(a);return n.setLoop(t?s.LoopRepeat:s.LoopOnce,t?1/0:1),n.fadeIn(i),n.play(),this.currentAnimation=n,n}stopAnimation(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.2;this.currentAnimation&&(this.currentAnimation.fadeOut(e),this.currentAnimation=null)}updateAnimations(e){this.animationMixer&&this.animationMixer.update(e)}setupInstancing(e,t){this.isInstanced=!0,this.instancedMesh=e,this.instanceId=t}updateInstanceMatrix(e){this.isInstanced&&this.instancedMesh&&this.instanceId>=0&&(this.instancedMesh.setMatrixAt(this.instanceId,e),this.instancedMesh.instanceMatrix.needsUpdate=!0)}setInstanceVisible(e){if(this.isInstanced&&this.instancedMesh&&this.instanceId>=0){let t=new s.Matrix4;this.instancedMesh.getMatrixAt(this.instanceId,t),e||t.scale(new s.Vector3(0,0,0)),this.instancedMesh.setMatrixAt(this.instanceId,t),this.instancedMesh.instanceMatrix.needsUpdate=!0}}disposeMesh(){this.mesh&&(this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.mesh=null)}dispose(){this.disposeMesh(),this.geometry&&(this.geometry.dispose(),this.geometry=null),this.material&&(Array.isArray(this.material)?this.material.forEach(e=>e.dispose()):this.material.dispose(),this.material=null),this.animationMixer&&(this.animationMixer.stopAllAction(),this.animationMixer=null),this.animations=[],this.currentAnimation=null,this.instancedMesh=null}reset(){this.dispose(),this.castShadow=!0,this.receiveShadow=!0,this.frustumCulled=!0,this.visible=!0,this.renderOrder=0,this.needsUpdate=!0,this.isInstanced=!1,this.instanceId=-1,this.enabled=!0}clone(){return new n({castShadow:this.castShadow,receiveShadow:this.receiveShadow,frustumCulled:this.frustumCulled,visible:this.visible,renderOrder:this.renderOrder})}constructor(e={}){var t,i,s,a,n;super(),this.componentType="Renderer",this.mesh=null,this.geometry=null,this.material=null,this.animationMixer=null,this.animations=[],this.currentAnimation=null,this.isInstanced=!1,this.instancedMesh=null,this.instanceId=-1,this.castShadow=null===(t=e.castShadow)||void 0===t||t,this.receiveShadow=null===(i=e.receiveShadow)||void 0===i||i,this.frustumCulled=null===(s=e.frustumCulled)||void 0===s||s,this.visible=null===(a=e.visible)||void 0===a||a,this.renderOrder=null!==(n=e.renderOrder)&&void 0!==n?n:0,this.needsUpdate=!0}}n.componentType="Renderer"},3974:function(e,t,i){i.d(t,{W:function(){return a}});var s=i(3980);class a extends s.w{absorbDamage(e){if(this.currentShield<=0)return e;let t=Math.min(e,this.currentShield);return this.currentShield-=t,this.lastDamageTime=Date.now(),this.isRegenerating=!1,e-t}update(e){if(this.currentShield>=this.maxShield){this.isRegenerating=!1;return}if((Date.now()-this.lastDamageTime)/1e3>=this.regenDelay){this.isRegenerating||(this.isRegenerating=!0);let t=this.regenRate*e;this.currentShield=Math.min(this.maxShield,this.currentShield+t)}}getShieldPercentage(){return this.maxShield>0?this.currentShield/this.maxShield:0}isFullShield(){return this.currentShield>=this.maxShield}isShieldDepleted(){return this.currentShield<=0}restoreShield(){this.currentShield=this.maxShield,this.isRegenerating=!1}setShield(e,t){this.currentShield=Math.max(0,Math.min(t,e)),this.maxShield=t}reset(){this.currentShield=this.maxShield,this.lastDamageTime=0,this.isRegenerating=!1,this.enabled=!0}constructor(e=200,t=20,i=5){super(),this.componentType="Shield",this.maxShield=e,this.currentShield=e,this.regenRate=t,this.regenDelay=i,this.lastDamageTime=0,this.isRegenerating=!1}}a.componentType="Shield"},2115:function(e,t,i){i.d(t,{N:function(){return a}});var s=i(3980);class a extends s.w{canAttack(e){return!!this.isActive&&!this.isDead&&!!this.currentTarget&&e-this.lastAttackTime>=this.attackCooldown}performAttack(e){this.lastAttackTime=e}canSearchForTargets(e){return e-this.lastTargetSearchTime>=this.targetSearchCooldown}updateTargetSearch(e){this.lastTargetSearchTime=e}setTarget(e){this.currentTarget=e}clearTarget(){this.currentTarget=null}die(e){this.isDead=!0,this.isActive=!1,this.deathTime=e,this.clearTarget()}getDisplayName(){return"Tower ".concat(this.towerIndex+1," (Owner: ").concat(this.ownerId,")")}reset(){this.ownerId="",this.towerIndex=0,this.attackRange=8,this.attackDamage=10,this.attackCooldown=1.5,this.lastAttackTime=0,this.projectileSpeed=20,this.currentTarget=null,this.targetSearchRange=9,this.lastTargetSearchTime=0,this.targetSearchCooldown=.5,this.isActive=!0,this.isDead=!1,this.deathTime=0,this.enabled=!0}clone(){let e=new a(this.ownerId,this.towerIndex);return e.attackRange=this.attackRange,e.attackDamage=this.attackDamage,e.attackCooldown=this.attackCooldown,e.lastAttackTime=this.lastAttackTime,e.projectileSpeed=this.projectileSpeed,e.currentTarget=this.currentTarget,e.targetSearchRange=this.targetSearchRange,e.lastTargetSearchTime=this.lastTargetSearchTime,e.targetSearchCooldown=this.targetSearchCooldown,e.isActive=this.isActive,e.isDead=this.isDead,e.deathTime=this.deathTime,e}constructor(e="",t=0){super(),this.componentType="Tower",this.ownerId=e,this.towerIndex=t,this.attackRange=10,this.attackDamage=10,this.attackCooldown=1.5,this.lastAttackTime=0,this.projectileSpeed=20,this.currentTarget=null,this.targetSearchRange=this.attackRange+1,this.lastTargetSearchTime=0,this.targetSearchCooldown=.5,this.isActive=!0,this.isDead=!1,this.deathTime=0}}a.componentType="Tower"},73:function(e,t,i){i.d(t,{w:function(){return n}});var s=i(1448),a=i(3980);class n extends a.w{setPosition(e,t,i){this.position.set(e,t,i),this.markMatrixDirty()}setRotation(e,t,i){this.rotation.set(e,t,i),this.updateQuaternion(),this.markMatrixDirty()}setScale(e,t,i){this.scale.set(e,t,i),this.markMatrixDirty()}translate(e,t,i){this.position.x+=e,this.position.y+=t,this.position.z+=i,this.markMatrixDirty()}rotate(e,t,i){this.rotation.x+=e,this.rotation.y+=t,this.rotation.z+=i,this.updateQuaternion(),this.markMatrixDirty()}lookAt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new s.Vector3(0,1,0),i=new s.Matrix4;i.lookAt(this.position,e,t),this.quaternion.setFromRotationMatrix(i),this.rotation.setFromQuaternion(this.quaternion),this.markMatrixDirty()}getForward(){let e=new s.Vector3(0,0,-1);return e.applyQuaternion(this.quaternion),e}getRight(){let e=new s.Vector3(1,0,0);return e.applyQuaternion(this.quaternion),e}getUp(){let e=new s.Vector3(0,1,0);return e.applyQuaternion(this.quaternion),e}getWorldPosition(){this.updateWorldMatrix();let e=new s.Vector3;return e.setFromMatrixPosition(this.worldMatrix),e}getWorldRotation(){this.updateWorldMatrix();let e=new s.Quaternion;return e.setFromRotationMatrix(this.worldMatrix),e}getWorldScale(){this.updateWorldMatrix();let e=new s.Vector3;return e.setFromMatrixScale(this.worldMatrix),e}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixNeedsUpdate=!1}updateWorldMatrix(){this.matrixNeedsUpdate&&this.updateMatrix(),this.parent?(this.parent.updateWorldMatrix(),this.worldMatrix.multiplyMatrices(this.parent.worldMatrix,this.matrix)):this.worldMatrix.copy(this.matrix)}addChild(e){e.parent&&e.parent.removeChild(e),e.parent=this,this.children.push(e)}removeChild(e){let t=this.children.indexOf(e);-1!==t&&(this.children.splice(t,1),e.parent=null)}removeFromParent(){this.parent&&this.parent.removeChild(this)}updateQuaternion(){this.quaternion.setFromEuler(this.rotation)}markMatrixDirty(){for(let e of(this.matrixNeedsUpdate=!0,this.children))e.markMatrixDirty()}reset(){for(this.position?this.position.set(0,0,0):this.position=new s.Vector3(0,0,0),this.rotation?this.rotation.set(0,0,0):this.rotation=new s.Euler(0,0,0),this.scale?this.scale.set(1,1,1):this.scale=new s.Vector3(1,1,1),this.quaternion?this.quaternion.set(0,0,0,1):this.quaternion=new s.Quaternion,this.matrix?this.matrix.identity():this.matrix=new s.Matrix4,this.worldMatrix?this.worldMatrix.identity():this.worldMatrix=new s.Matrix4,this.matrixNeedsUpdate=!0,this.removeFromParent();this.children.length>0;)this.removeChild(this.children[0]);this.enabled=!0}clone(){let e=new n(this.position,this.rotation,this.scale);return e.quaternion.copy(this.quaternion),e}constructor(e=new s.Vector3(0,0,0),t=new s.Euler(0,0,0),i=new s.Vector3(1,1,1)){super(),this.componentType="Transform",this.matrixNeedsUpdate=!0,this.parent=null,this.children=[],this.position=e.clone(),this.rotation=t.clone(),this.scale=i.clone(),this.quaternion=new s.Quaternion,this.matrix=new s.Matrix4,this.worldMatrix=new s.Matrix4,this.updateQuaternion()}}n.componentType="Transform"},2082:function(e,t,i){i.d(t,{D:function(){return r}});var s=i(1448),a=i(9131),n=i(73),o=i(6366);class r extends a.xP{setTarget(e){this.target=e}setConfig(e){this.config={...this.config,...e},this.spherical.radius=this.config.distance}update(e,t){if(!this.target)return;let i=this.target.getComponent(n.w);i&&(this.handleMouseInput(),this.targetLookAt.copy(i.position),this.targetLookAt.y+=this.config.height,this.targetPosition.setFromSpherical(this.spherical),this.targetPosition.add(this.targetLookAt),this.currentPosition.lerp(this.targetPosition,this.config.smoothing),this.currentLookAt.lerp(this.targetLookAt,this.config.smoothing),this.camera.position.copy(this.currentPosition),this.camera.lookAt(this.currentLookAt))}handleMouseInput(){let e=this.inputManager.getMouseDelta();(0!==e.x||0!==e.y)&&this.isRightMouseDown&&(this.spherical.theta-=e.x*this.config.mouseSensitivity,this.spherical.phi-=e.y*this.config.mouseSensitivity,this.spherical.phi=o.M.clamp(this.spherical.phi,this.config.minPolarAngle,this.config.maxPolarAngle),this.spherical.theta=o.M.normalizeAngle(this.spherical.theta))}setupEventListeners(){this.inputManager.on("mouseDown",e=>{let{button:t}=e;2===t&&(this.isRightMouseDown=!0)}),this.inputManager.on("mouseUp",e=>{let{button:t}=e;2===t&&(this.isRightMouseDown=!1)}),this.wheelListenerAdded||(this.inputManager.on("wheel",e=>{let{deltaY:t}=e;this.spherical.radius+=.01*t,this.spherical.radius=o.M.clamp(this.spherical.radius,2,this.config.maxDistance)}),this.wheelListenerAdded=!0)}setupInitialPosition(){this.currentPosition.setFromSpherical(this.spherical),this.currentLookAt.set(0,this.config.height,0),this.targetPosition.copy(this.currentPosition),this.targetLookAt.copy(this.currentLookAt),this.camera.position.copy(this.currentPosition),this.camera.lookAt(this.currentLookAt)}getCameraDirection(){let e=new s.Vector3;return this.camera.getWorldDirection(e),e}getCameraRight(){let e=this.getCameraDirection(),t=new s.Vector3;return t.crossVectors(e,new s.Vector3(0,1,0)),t.normalize(),t}getCameraForward(){let e=this.getCameraRight(),t=new s.Vector3;return t.crossVectors(new s.Vector3(0,1,0),e),t.normalize(),t}getDistance(){return this.spherical.radius}setDistance(e){this.spherical.radius=o.M.clamp(e,2,this.config.maxDistance)}getHorizontalAngle(){return this.spherical.theta}getVerticalAngle(){return this.spherical.phi}setAngles(e,t){this.spherical.theta=o.M.normalizeAngle(e),this.spherical.phi=o.M.clamp(t,this.config.minPolarAngle,this.config.maxPolarAngle)}resetCamera(){this.spherical.radius=this.config.distance,this.spherical.phi=Math.PI/3,this.spherical.theta=0,this.setupInitialPosition()}snapToTarget(){if(!this.target)return;let e=this.target.getComponent(n.w);if(e&&e.position){if(void 0===e.position.x||void 0===e.position.y||void 0===e.position.z){console.warn("CameraSystem: Target position is not properly initialized, skipping snapToTarget");return}this.targetLookAt.copy(e.position),this.targetLookAt.y+=this.config.height,this.targetPosition.setFromSpherical(this.spherical),this.targetPosition.add(this.targetLookAt),this.currentPosition.copy(this.targetPosition),this.currentLookAt.copy(this.targetLookAt),this.camera.position.copy(this.currentPosition),this.camera.lookAt(this.currentLookAt)}}getCamera(){return this.camera}constructor(e,t,i){super(),this.requiredComponents=[n.w],this.target=null,this.config={distance:10,height:5,mouseSensitivity:.005,smoothing:.1,minPolarAngle:Math.PI/3.5,maxPolarAngle:Math.PI/2.5,maxDistance:11.5},this.spherical=new s.Spherical(10,Math.PI/3,0),this.targetPosition=new s.Vector3,this.currentPosition=new s.Vector3,this.currentLookAt=new s.Vector3,this.targetLookAt=new s.Vector3,this.isRightMouseDown=!1,this.wheelListenerAdded=!1,this.camera=e,this.inputManager=t,this.priority=900,i&&(this.config={...this.config,...i}),this.spherical.radius=this.config.distance,this.spherical.phi=Math.PI/3,this.spherical.theta=0,this.setupEventListeners(),this.setupInitialPosition()}}},2158:function(e,t,i){i.d(t,{s:function(){return l}});var s=i(1448),a=i(9131),n=i(73),o=i(7771),r=i(3478),h=i(4183);class l extends a.FU{update(e,t){this.updateSpatialHash(e),this.detectCollisions(e),this.processCollisionCallbacks(),this.resolveCollisions()}fixedUpdate(e,t){this.resolveCollisions()}updateSpatialHash(e){for(let t of e){let e=t.getComponent(n.w),i=t.getComponent(r.YM);if(!e.enabled||!i.enabled){this.spatialHash.remove(t);continue}i.updateBounds(e.getWorldPosition()),this.spatialHash.update(t,i.bounds)}}detectCollisions(e){this.collisionPairs.length=0,this.collisionChecks=0,this.actualCollisions=0;let t=new Set;for(let i of e){let e=i.getComponent(n.w),s=i.getComponent(r.YM);if(e.enabled&&s.enabled)for(let a of this.spatialHash.query(s.bounds)){let o=a.entity;if(i.id===o.id)continue;let h=i.id<o.id?"".concat(i.id,"-").concat(o.id):"".concat(o.id,"-").concat(i.id);if(t.has(h))continue;t.add(h);let l=o.getComponent(n.w),c=o.getComponent(r.YM);if((null==l?void 0:l.enabled)&&(null==c?void 0:c.enabled)&&s.canCollideWith(c)&&(this.collisionChecks++,s.intersects(c,e.getWorldPosition(),l.getWorldPosition()))){this.actualCollisions++,2===s.layer&&16===c.layer||16===s.layer&&c.layer;let e={entityA:i,entityB:o,colliderA:s,colliderB:c};this.collisionPairs.push(e)}}}}processCollisionCallbacks(){let e=new Map;for(let t of this.collisionPairs){let i=t.entityA.id<t.entityB.id?"".concat(t.entityA.id,"-").concat(t.entityB.id):"".concat(t.entityB.id,"-").concat(t.entityA.id);e.set(i,t),this.activeCollisions.has(i)?this.triggerCollisionStay(t):this.triggerCollisionEnter(t)}this.activeCollisions.forEach((t,i)=>{e.has(i)||this.triggerCollisionExit(t)}),this.activeCollisions=e}triggerCollisionEnter(e){var t,i,s,a,n,o,r,h;e.colliderA.isTrigger||e.colliderB.isTrigger?(null===(t=(i=e.colliderA).onTriggerEnter)||void 0===t||t.call(i,e.colliderB,e.entityB),null===(s=(a=e.colliderB).onTriggerEnter)||void 0===s||s.call(a,e.colliderA,e.entityA)):(null===(n=(o=e.colliderA).onCollisionEnter)||void 0===n||n.call(o,e.colliderB,e.entityB),null===(r=(h=e.colliderB).onCollisionEnter)||void 0===r||r.call(h,e.colliderA,e.entityA))}triggerCollisionStay(e){var t,i,s,a,n,o,r,h;e.colliderA.isTrigger||e.colliderB.isTrigger?(null===(t=(i=e.colliderA).onTriggerStay)||void 0===t||t.call(i,e.colliderB,e.entityB),null===(s=(a=e.colliderB).onTriggerStay)||void 0===s||s.call(a,e.colliderA,e.entityA)):(null===(n=(o=e.colliderA).onCollisionStay)||void 0===n||n.call(o,e.colliderB,e.entityB),null===(r=(h=e.colliderB).onCollisionStay)||void 0===r||r.call(h,e.colliderA,e.entityA))}triggerCollisionExit(e){var t,i,s,a,n,o,r,h;e.colliderA.isTrigger||e.colliderB.isTrigger?(null===(t=(i=e.colliderA).onTriggerExit)||void 0===t||t.call(i,e.colliderB,e.entityB),null===(s=(a=e.colliderB).onTriggerExit)||void 0===s||s.call(a,e.colliderA,e.entityA)):(null===(n=(o=e.colliderA).onCollisionExit)||void 0===n||n.call(o,e.colliderB,e.entityB),null===(r=(h=e.colliderB).onCollisionExit)||void 0===r||r.call(h,e.colliderA,e.entityA))}resolveCollisions(){for(let e of this.collisionPairs)e.colliderA.isTrigger||e.colliderB.isTrigger||this.resolveCollision(e)}resolveCollision(e){let t=e.entityA.getComponent(n.w),i=e.entityB.getComponent(n.w),s=t.getWorldPosition(),a=i.getWorldPosition();if(!s||!s.clone||!a||!a.clone)return;let h=s.clone().sub(a),l=h.length();0===l?h.set(0,1,0):h.normalize();let c=0,d=("sphere"===e.colliderA.type&&"sphere"===e.colliderB.type?e.colliderA.radius+e.colliderB.radius:"sphere"===e.colliderA.type&&"cylinder"===e.colliderB.type?e.colliderA.radius+e.colliderB.radius:"cylinder"===e.colliderA.type&&"sphere"===e.colliderB.type?e.colliderA.radius+e.colliderB.radius:this.getApproximateRadius(e.colliderA)+this.getApproximateRadius(e.colliderB))-l;if(d>0){2===e.colliderA.layer&&16===e.colliderB.layer||16===e.colliderA.layer&&e.colliderB.layer;let s=1;(e.colliderA.isStatic||e.colliderB.isStatic)&&(s=1.1);let a=h.multiplyScalar(d*s),n=e.entityA.getComponent(o.i),l=e.entityB.getComponent(o.i),c=.5,m=.5;if(e.colliderA.isStatic&&!e.colliderB.isStatic)c=0,m=1;else if(!e.colliderA.isStatic&&e.colliderB.isStatic)c=1,m=0;else if(!e.colliderA.isStatic&&!e.colliderB.isStatic){let t=e.colliderA.layer===r.aB.PLAYER,i=e.colliderB.layer===r.aB.PLAYER||e.colliderB.layer===r.aB.ENEMY;if(t&&i){let e=!!n&&n.canMove,t=!!l&&l.canMove;e&&t?(c=.5,m=.5):e&&!t?(c=1,m=0):!e&&t?(c=0,m=1):(c=0,m=0)}else n&&!l?(c=.8,m=.2):!n&&l&&(c=.2,m=.8)}if(c>0&&a&&a.clone){let i=a.clone().multiplyScalar(c);if(t.translate(i.x,i.y,i.z),n&&e.colliderB.isStatic&&n.velocity&&n.velocity.clone&&h&&h.clone){let e=n.velocity.clone().projectOnVector(h.clone().negate());e.length()>0&&n.velocity.sub(e)}}if(m>0){let t=a.clone().multiplyScalar(-m);if(i.translate(t.x,t.y,t.z),l&&e.colliderA.isStatic){let e=l.velocity.clone().projectOnVector(h);e.length()>0&&l.velocity.sub(e)}}}}getApproximateRadius(e){switch(e.type){case"sphere":return e.radius;case"box":return .5*Math.max(e.size.x,e.size.y,e.size.z);case"capsule":case"cylinder":return Math.max(e.radius,.5*e.height);default:return .5}}queryColliders(e){return this.spatialHash.query(e).map(e=>e.entity)}queryCollidersRadius(e,t){return this.spatialHash.queryRadius(e,t).map(e=>e.entity)}queryCollidersPoint(e){return this.spatialHash.queryPoint(e).map(e=>e.entity)}getCollidersInLayer(e,t){return(t?this.spatialHash.query(t):Array.from(this.spatialHash.entityCells.keys()).map(e=>this.spatialHash.query(new s.Box3().setFromCenterAndSize(new s.Vector3,new s.Vector3(1e3,1e3,1e3))).find(t=>t.entity.id===e)).filter(Boolean)).filter(t=>{let i=t.entity.getComponent(r.YM);return i&&i.layer===e}).map(e=>e.entity)}getPerformanceStats(){return{collisionChecks:this.collisionChecks,actualCollisions:this.actualCollisions,activeCollisions:this.activeCollisions.size,spatialHashStats:this.spatialHash.getStats()}}onEntityRemoved(e){this.spatialHash.remove(e);let t=[];for(let i of(this.activeCollisions.forEach((i,s)=>{(i.entityA.id===e.id||i.entityB.id===e.id)&&t.push(s)}),t))this.activeCollisions.delete(i)}onDisable(){this.spatialHash.clear(),this.activeCollisions.clear(),this.collisionPairs.length=0}constructor(e=5){super(),this.requiredComponents=[n.w,r.YM],this.collisionPairs=[],this.activeCollisions=new Map,this.lastUpdateTime=0,this.collisionChecks=0,this.actualCollisions=0,this.priority=15,this.spatialHash=new h.k(e)}}},244:function(e,t,i){i.d(t,{b:function(){return m}});var s=i(9131),a=i(6862),n=i(3974),o=i(8001),r=i(73),h=i(246),l=i(7771),c=i(5050),d=i(6121);class m extends s.xP{shouldLogDamage(){let e=Date.now();return e-this.lastDamageLogTime>this.damageLogThrottle&&(this.lastDamageLogTime=e,!0)}setEnemyDamageCallback(e){this.onEnemyDamageCallback=e}setPlayerDamageCallback(e){this.onPlayerDamageCallback=e}update(e,t){let i=Date.now()/1e3;this.updateHealthComponents(e,t,i),this.processDamageQueue(i),this.processHealQueue(i),this.handleDeathAndRespawn(e,i),this.damageNumberManager.cleanup(),this.damageQueue.length=0,this.healQueue.length=0,this.deadEntities.length=0}updateHealthComponents(e,t,i){for(let s of e){let e=s.getComponent(a.S);if(!e||!e.enabled)continue;e.update(t,i);let r=s.getComponent(n.W);r&&r.update(t);let h=s.getComponent(o.C);h&&h.updateFreezeStatus(i)}}processDamageQueue(e){for(let t of this.damageQueue)this.applyDamage(t,e)}processHealQueue(e){for(let t of this.healQueue)this.applyHealing(t,e)}applyDamage(e,t){let{target:i,damage:s,source:n,damageType:h}=e,l=i.getComponent(a.S);if(!l||!l.enabled)return;if("charge"===h){let e=i.getComponent(o.C),t=e?"Enemy(".concat(e.getDisplayName(),")"):"Player(".concat(i.id,")");console.log(" CombatSystem processing charge damage: ".concat(s," to ").concat(t,", source: ").concat(null==n?void 0:n.id,", hasPlayerCallback: ").concat(!!this.onPlayerDamageCallback))}let d=i.getComponent(o.C);if(d&&this.onEnemyDamageCallback){let e=(0,c.g3)(s),t=e.damage;console.log("\uD83C\uDF10 Routing ".concat(t," damage to enemy ").concat(i.id," through multiplayer server")),this.onEnemyDamageCallback(i.id.toString(),t);let a=i.getComponent(r.w);if(a){let i=a.getWorldPosition();i.y+=1.5,this.damageNumberManager.addDamageNumber(t,e.isCritical,i,h)}let o=n?"Entity ".concat(n.id):"Unknown",l=this.getEntityDisplayName(i),d=e.isCritical?" CRITICAL":"";console.log("\uD83D\uDCA5 ".concat(o," dealt ").concat(t).concat(d," ").concat(h||"damage"," to ").concat(l," (routed to server)"));return}if(!d&&this.onPlayerDamageCallback&&n&&n.id!==i.id){let e=(0,c.g3)(s);this.shouldLogDamage()&&console.log(" Routing ".concat(e.damage," PVP ").concat(h||"damage"," to player ").concat(i.id," through multiplayer server")),this.onPlayerDamageCallback(i.id.toString(),e.damage,h);let t=i.getComponent(r.w);if(t){let i=t.getWorldPosition();i&&void 0!==i.x&&void 0!==i.y&&void 0!==i.z?(i.y+=1.5,"sabres_right"===h&&(i.x+=.3),this.damageNumberManager.addDamageNumber(e.damage,e.isCritical,i,h||"pvp")):console.warn(" Skipping PVP damage number creation - invalid position:",i)}if(this.shouldLogDamage()){let t=n?"Player ".concat(n.id):"Unknown",s="Player ".concat(i.id),a=e.isCritical?" CRITICAL":"";console.log(" ".concat(t," dealt ").concat(e.damage).concat(a," PVP ").concat(h||"damage"," to ").concat(s," (routed to server)"))}return}let m=(0,c.g3)(s),u=m.damage;if(l.takeDamage(u,t,i)){this.totalDamageDealt+=u;let e=i.getComponent(r.w);if(e){let t=e.getWorldPosition();t&&void 0!==t.x&&void 0!==t.y&&void 0!==t.z?(t.y+=3,this.damageNumberManager.addDamageNumber(u,m.isCritical,t,h)):console.warn(" Skipping damage number creation - invalid position:",t)}if(this.shouldLogDamage()){let e=n?"Entity ".concat(n.id):"Unknown",t=this.getEntityDisplayName(i),s=m.isCritical?" CRITICAL":"";console.log("\uD83D\uDCA5 ".concat(e," dealt ").concat(u).concat(s," ").concat(h||"damage"," to ").concat(t," (").concat(l.currentHealth,"/").concat(l.maxHealth," HP)"))}l.isDead&&this.handleEntityDeath(i,n,t),this.triggerDamageEffects(i,u,n,h,m.isCritical)}}applyHealing(e,t){let{target:i,amount:s,source:n}=e,o=i.getComponent(a.S);if(o&&o.enabled&&o.heal(s)){this.totalHealingDone+=s;let e=n?"Entity ".concat(n.id):"Unknown",t=this.getEntityDisplayName(i);console.log("\uD83D\uDC9A ".concat(e," healed ").concat(t," for ").concat(s," HP (").concat(o.currentHealth,"/").concat(o.maxHealth," HP)")),this.triggerHealingEffects(i,s,n)}}handleEntityDeath(e,t,i){let s=e.getComponent(o.C);s&&(s.die(i||Date.now()/1e3),this.enemiesKilled++,console.log("\uD83D\uDC80 ".concat(s.getDisplayName()," has been defeated!")),t&&this.awardExperience(t,s.experienceReward),this.triggerDeathEffects(e,t)),this.deadEntities.push(e)}handleDeathAndRespawn(e,t){for(let i of e){let e=i.getComponent(a.S),s=i.getComponent(o.C);e&&s&&s.isDead&&s.canRespawnNow(t)&&this.respawnEnemy(i,s,e)}}respawnEnemy(e,t,i){t.respawn(),i.revive(),console.log("\uD83D\uDD04 ".concat(t.getDisplayName()," has respawned!")),this.triggerRespawnEffects(e)}triggerDamageEffects(e,t,i,s,a){let n=e.getComponent(r.w);if(n&&console.log("\uD83C\uDFAF Damage effect".concat(a?" (CRITICAL)":""," at position:"),n.position),"projectile"===s&&i){var o,c;let t=i.getComponent(h.T);if(null==t?void 0:null===(c=t.mesh)||void 0===c?void 0:null===(o=c.userData)||void 0===o?void 0:o.isBarrageArrow){console.log("\uD83C\uDFF9 Barrage arrow hit detected, applying slow effect to target ".concat(e.id));let t=e.getComponent(l.i);t&&(t.slow(5e3,.5),console.log("\uD83D\uDC0C Applied 50% slow for 5 seconds to target ".concat(e.id)))}}}triggerHealingEffects(e,t,i){let s=e.getComponent(r.w);s&&console.log(" Healing effect at position:",s.position)}triggerDeathEffects(e,t){let i=e.getComponent(r.w);i&&console.log("\uD83D\uDC80 Death effect at position:",i.position)}triggerRespawnEffects(e){let t=e.getComponent(r.w);t&&console.log("\uD83C\uDF1F Respawn effect at position:",t.position)}awardExperience(e,t){console.log(" Entity ".concat(e.id," gained ").concat(t," experience!"))}getEntityDisplayName(e){let t=e.getComponent(o.C);return t?t.getDisplayName():"Entity ".concat(e.id)}queueDamage(e,t,i,s){this.damageQueue.push({target:e,damage:t,source:i,damageType:s,timestamp:Date.now()/1e3})}queueHealing(e,t,i){this.healQueue.push({target:e,amount:t,source:i,timestamp:Date.now()/1e3})}dealDamageImmediate(e,t,i,s){let n=e.getComponent(a.S);if(!n||!n.enabled)return!1;let o=(0,c.g3)(t),h=o.damage,l=Date.now()/1e3,d=n.takeDamage(h,l,e);if(d){this.totalDamageDealt+=h;let t=e.getComponent(r.w);if(t){let e=t.getWorldPosition();e.y+=1.5,this.damageNumberManager.addDamageNumber(h,o.isCritical,e,s)}n.isDead&&this.handleEntityDeath(e,i,l),this.triggerDamageEffects(e,h,i,s,o.isCritical)}return d}healImmediate(e,t,i){let s=e.getComponent(a.S);if(!s||!s.enabled)return!1;let n=s.heal(t);return n&&(this.totalHealingDone+=t,this.triggerHealingEffects(e,t,i)),n}isEntityDead(e){let t=e.getComponent(a.S);return!!t&&t.isDead}getEntityHealthRatio(e){let t=e.getComponent(a.S);return t?t.getHealthRatio():0}canEntityTakeDamage(e){let t=e.getComponent(a.S);return!!t&&!t.isDead&&!t.isInvulnerable}getCombatStats(){return{totalDamageDealt:this.totalDamageDealt,totalHealingDone:this.totalHealingDone,enemiesKilled:this.enemiesKilled,queuedDamageEvents:this.damageQueue.length,queuedHealEvents:this.healQueue.length}}resetStats(){this.totalDamageDealt=0,this.totalHealingDone=0,this.enemiesKilled=0}getDamageNumbers(){return this.damageNumberManager.getDamageNumbers()}removeDamageNumber(e){this.damageNumberManager.removeDamageNumber(e)}onDisable(){this.damageQueue.length=0,this.healQueue.length=0,this.deadEntities.length=0,this.damageNumberManager.clear(),this.resetStats()}constructor(e){super(),this.requiredComponents=[a.S],this.damageQueue=[],this.healQueue=[],this.deadEntities=[],this.totalDamageDealt=0,this.totalHealingDone=0,this.enemiesKilled=0,this.lastDamageLogTime=0,this.damageLogThrottle=100,this.world=e,this.damageNumberManager=new d.w,this.priority=25}}},7223:function(e,t,i){i.d(t,{s:function(){return f}});var s=i(1448),a=i(9131),n=i(73),o=i(7771),r=i(6862),h=i(8001),l=i(246),c=i(3478),d=i(244),m=i(7125),u=i(8815),g=i(6932),p=i(7019),y=i(319);class f extends a.xP{setPlayer(e){this.playerEntity=e}update(e,t){if(!this.playerEntity)return;let i=this.playerEntity.getComponent(n.w),s=this.playerEntity.getComponent(o.i);i&&s&&("function"==typeof s.updateDebuffs&&s.updateDebuffs(),this.handleWeaponSwitching(),this.handleDashMovement(s,i),this.handleChargeMovement(s,i),s.isDashing||s.isCharging||s.isFrozen||this.isSkyfalling||this.handleMovementInput(s),this.handleCombatInput(i),this.updateDeflectBarrier(i))}handleMovementInput(e){if(!this.playerEntity)return;let t=this.playerEntity.getComponent(n.w);if(!t)return;this.checkForDashInput(e,t);let i=new s.Vector3(0,0,0),a=!1;if(this.inputManager.isKeyPressed("w")&&(i.z-=1,a=!0),this.inputManager.isKeyPressed("s")&&(i.z+=1,a=!0),this.inputManager.isKeyPressed("a")&&(i.x-=1,a=!0),this.inputManager.isKeyPressed("d")&&(i.x+=1,a=!0),i.length()>0&&i.normalize(),a){let t=new s.Vector3;this.camera.getWorldDirection(t);let a=new s.Vector3;a.crossVectors(t,new s.Vector3(0,1,0)).normalize();let n=new s.Vector3;n.crossVectors(new s.Vector3(0,1,0),a).normalize();let o=new s.Vector3;o.addScaledVector(a,i.x),o.addScaledVector(n,-i.z),o.normalize(),e.setMoveDirection(o,1)}else e.setMoveDirection(new s.Vector3(0,0,0),0);this.inputManager.isKeyPressed(" ")&&e.jump()}handleWeaponSwitching(){let e=Date.now()/1e3;!(e-this.lastWeaponSwitchTime<this.weaponSwitchCooldown)&&(this.inputManager.isKeyPressed("1")?this.currentWeapon!==m.v.SWORD&&(this.resetAllAbilityStates(),this.currentWeapon=m.v.SWORD,this.currentSubclass=m.p.DIVINITY,this.fireRate=this.swordFireRate,this.lastWeaponSwitchTime=e,this.swordComboStep=1):this.inputManager.isKeyPressed("2")?this.currentWeapon!==m.v.BOW&&(this.resetAllAbilityStates(),this.currentWeapon=m.v.BOW,this.currentSubclass=m.p.ELEMENTAL,this.fireRate=.225,this.lastWeaponSwitchTime=e):this.inputManager.isKeyPressed("3")?this.currentWeapon!==m.v.SCYTHE&&(this.resetAllAbilityStates(),this.currentWeapon=m.v.SCYTHE,this.currentSubclass=m.p.CHAOS,this.fireRate=this.scytheFireRate,this.lastWeaponSwitchTime=e):this.inputManager.isKeyPressed("4")&&this.currentWeapon!==m.v.SABRES&&(this.resetAllAbilityStates(),this.currentWeapon=m.v.SABRES,this.currentSubclass=m.p.FROST,this.fireRate=this.sabresFireRate,this.lastWeaponSwitchTime=e))}handleCombatInput(e){this.currentWeapon===m.v.BOW?this.handleBowInput(e):this.currentWeapon===m.v.SCYTHE?this.handleScytheInput(e):this.currentWeapon===m.v.SWORD?this.handleSwordInput(e):this.currentWeapon===m.v.SABRES&&this.handleSabresInput(e)}handleBowInput(e){if(!this.inputManager.isKeyPressed("r")||this.isViperStingCharging||this.isCharging||this.performViperSting(e),!this.inputManager.isKeyPressed("q")||this.isBarrageCharging||this.isCharging||this.isViperStingCharging||this.performBarrage(e),!this.inputManager.isKeyPressed("e")||this.isCharging||this.isViperStingCharging||this.isBarrageCharging||this.isCobraShotCharging||this.performCobraShot(e),this.inputManager.isMouseButtonPressed(0))this.isCharging||this.isViperStingCharging||this.isBarrageCharging||this.isCobraShotCharging||(this.isCharging=!0,this.chargeProgress=0),this.isViperStingCharging||this.isBarrageCharging||this.isCobraShotCharging||(this.chargeProgress=Math.min(this.chargeProgress+.0125,1));else if(this.isCharging){if(this.isViperStingCharging||this.isBarrageCharging||this.isCobraShotCharging){this.isCharging=!1,this.chargeProgress=0;return}let t=this.chargeProgress;this.fireProjectile(e),this.isCharging=!1,this.chargeProgress=0,this.triggerBowReleaseEffects(t)}}handleScytheInput(e){this.inputManager.isMouseButtonPressed(0)?(this.isCharging||(this.isCharging=!0,this.chargeProgress=0,console.log(" Started charging scythe (spinning)")),this.chargeProgress+=.03,this.fireEntropicBoltProjectile(e)):this.isCharging&&(this.isCharging=!1,this.chargeProgress=0),this.inputManager.isKeyPressed("r")&&!this.isCharging&&this.fireCrossentropyBoltAbility(e),this.inputManager.isKeyPressed("q")&&!this.isCharging&&this.performReanimateAbility(e),this.inputManager.isKeyPressed("e")&&!this.isCharging&&this.performFrostNovaAbility(e)}fireProjectile(e){let t=Date.now()/1e3;if(t-this.lastFireTime<this.fireRate)return;this.lastFireTime=t;let i=new s.Vector3;this.camera.getWorldDirection(i),i.normalize();let a=new s.Vector3;a.crossVectors(i,new s.Vector3(0,1,0)).normalize();let n=new s.Matrix4;n.makeRotationAxis(a,Math.PI/6),i.applyMatrix4(n),i.normalize();let o=this.chargeProgress>=.7&&this.chargeProgress<=.98;this.chargeProgress>=1?this.createChargedArrowProjectile(e.position.clone(),i):o?this.createPerfectShotProjectile(e.position.clone(),i):(i.x,i.z,this.createProjectile(e.position.clone(),i))}fireEntropicBoltProjectile(e){let t=Date.now()/1e3;if(t-this.lastFireTime<this.scytheFireRate)return;this.lastFireTime=t;let i=new s.Vector3;this.camera.getWorldDirection(i),i.normalize();let a=new s.Vector3;a.crossVectors(i,new s.Vector3(0,1,0)).normalize();let n=new s.Matrix4;n.makeRotationAxis(a,Math.PI/6),i.applyMatrix4(n),i.normalize(),this.isCharging,this.createEntropicBoltProjectile(e.position.clone(),i)}fireCrossentropyBoltAbility(e){let t=Date.now()/1e3;if(t-this.lastCrossentropyTime<this.crossentropyFireRate)return;this.lastCrossentropyTime=t;let i=new s.Vector3;this.camera.getWorldDirection(i),i.normalize();let a=new s.Vector3;a.crossVectors(i,new s.Vector3(0,1,0)).normalize();let n=new s.Matrix4;n.makeRotationAxis(a,Math.PI/6),i.applyMatrix4(n),i.normalize(),this.createCrossentropyBoltProjectile(e.position.clone(),i)}createProjectile(e,t){if(!this.playerEntity)return;let i=this.world.queryEntities([n.w,r.S,c.YM]).filter(e=>{var t;return e.id!==this.playerEntity.id&&!(null===(t=e.getComponent(r.S))||void 0===t?void 0:t.isDead)}).length>0,s=void 0!==this.onProjectileCreatedCallback;if(!i&&!s)return;let a=e.clone();a.add(t.clone().multiplyScalar(1)),a.y+=.75;let o={speed:25,damage:10,lifetime:3,maxDistance:25,subclass:this.currentSubclass,level:this.currentLevel,opacity:1};this.projectileSystem.createProjectile(this.world,a,t,this.playerEntity.id,o),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("regular_arrow",a,t,o)}createEntropicBoltProjectile(e,t){if(!this.playerEntity)return;let i=this.world.queryEntities([n.w,r.S,c.YM]).filter(e=>{var t;return e.id!==this.playerEntity.id&&!(null===(t=e.getComponent(r.S))||void 0===t?void 0:t.isDead)}).length>0,s=void 0!==this.onProjectileCreatedCallback;if(!i&&!s)return;let a=window.gameUI;if(a&&!a.canCastEntropicBolt())return;a&&a.consumeMana(10);let o=e.clone();o.add(t.clone().multiplyScalar(1)),o.y+=1;let h={speed:20,damage:20,lifetime:2,piercing:!1,explosive:!1,explosionRadius:0,subclass:this.currentSubclass,level:this.currentLevel,opacity:1};this.projectileSystem.createEntropicBoltProjectile(this.world,o,t,this.playerEntity.id,h),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("entropic_bolt",o,t,h)}createCrossentropyBoltProjectile(e,t){if(!this.playerEntity)return;let i=window.gameUI;if(i&&!i.canCastCrossentropyBolt())return;i&&(i.consumeMana(40),console.log(" Consumed 40 mana for Crossentropy Bolt"));let s=e.clone();s.add(t.clone().multiplyScalar(1)),s.y+=1;let a={speed:15,damage:90,lifetime:2.5,piercing:!1,explosive:!1,explosionRadius:0,subclass:this.currentSubclass,level:this.currentLevel,opacity:1};this.projectileSystem.createCrossentropyBoltProjectile(this.world,s,t,this.playerEntity.id,a),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("crossentropy_bolt",s,t,a)}performReanimateAbility(e){if(!this.playerEntity)return;let t=Date.now()/1e3;if(t-this.lastReanimateTime<1)return;this.lastReanimateTime=t;let i=window.gameUI;if(i&&i.getCurrentMana(),i&&!i.canCastReanimate())return;i&&(i.getCurrentMana(),i.consumeMana(20),i.getCurrentMana()),this.triggerReanimateEffect(e);let s=this.playerEntity.getComponent(r.S);s&&s.heal(30)}triggerReanimateEffect(e){this.onReanimateCallback&&this.onReanimateCallback(),e.position}performFrostNovaAbility(e){if(!this.playerEntity)return;let t=Date.now()/1e3;if(t-this.lastFrostNovaTime<this.frostNovaFireRate)return;let i=window.gameUI;if(i&&!i.canCastFrostNova())return;i&&i.consumeMana(50),this.lastFrostNovaTime=t;let a=e.getWorldPosition(),n=new s.Vector3;this.camera.getWorldDirection(n),n.normalize(),this.onFrostNovaCallback&&this.onFrostNovaCallback(a,n),this.freezeEnemiesInRadius(a,6,t),(0,g.triggerGlobalFrostNova)(a)}performCobraShot(e){if(!this.playerEntity)return;let t=Date.now()/1e3;if(t-this.lastCobraShotTime<this.cobraShotFireRate)return;let i=window.gameUI;if(i&&!i.canCastCobraShot())return;i&&i.consumeEnergy(40),this.isCobraShotCharging=!0,this.cobraShotChargeProgress=0,this.lastCobraShotTime=t;let s=Date.now(),a=setInterval(()=>{let t=Date.now()-s;this.cobraShotChargeProgress=Math.min(t/750,1),this.cobraShotChargeProgress>=1&&(clearInterval(a),this.fireCobraShot(e),this.isCobraShotCharging=!1,this.cobraShotChargeProgress=0)},16)}fireCobraShot(e){let t=e.getWorldPosition();t.y+=.825;let i=new s.Vector3;this.camera.getWorldDirection(i),i.normalize();let a=new s.Vector3;a.crossVectors(i,new s.Vector3(0,1,0)).normalize();let n=new s.Matrix4;n.makeRotationAxis(a,Math.PI/6),i.applyMatrix4(n),i.normalize();let o=t.clone();o.add(i.clone().multiplyScalar(1)),this.onCobraShotCallback&&this.onCobraShotCallback(o,i),(0,p.triggerGlobalCobraShot)(o,i),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("cobra_shot_projectile",o,i,{speed:20,damage:29,lifetime:8,venomDuration:6})}freezeEnemiesInRadius(e,t,i){let s=this.world.getAllEntities(),a=0,o=0;s.forEach(s=>{var l;let c=s.getComponent(n.w),m=s.getComponent(r.S);if(!c||!m||m.isDead||s.id===(null===(l=this.playerEntity)||void 0===l?void 0:l.id))return;let u=c.position;if(e.distanceTo(u)<=t){let e=s.getComponent(h.C);if(e)e.freeze(6,i),a++,(0,g.addGlobalFrozenEnemy)(s.id.toString(),u);else{let e=this.world.getSystem(d.b);e&&this.playerEntity&&(e.queueDamage(s,50,this.playerEntity,"frost_nova"),o++,this.onDebuffCallback&&this.onDebuffCallback(s.id,"frozen",6e3,u))}}})}createChargedArrowProjectile(e,t){if(!this.playerEntity)return;let i=e.clone();i.add(t.clone().multiplyScalar(1)),i.y+=.5;let s={speed:35,damage:50,lifetime:2,piercing:!0,explosive:!1,subclass:this.currentSubclass,level:this.currentLevel,opacity:1};this.projectileSystem.createChargedArrowProjectile(this.world,i,t,this.playerEntity.id,s),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("charged_arrow",i,t,s)}createPerfectShotProjectile(e,t){if(!this.playerEntity)return;let i=e.clone();i.add(t.clone().multiplyScalar(1)),i.y+=.5,this.projectileSystem.createChargedArrowProjectile(this.world,i,t,this.playerEntity.id,{speed:40,damage:75,lifetime:6,piercing:!0,explosive:!1,subclass:this.currentSubclass,level:this.currentLevel,opacity:1}),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("perfect_shot",i,t,{speed:40,damage:75,lifetime:6,piercing:!0,subclass:this.currentSubclass,level:this.currentLevel,opacity:1})}setWeaponSubclass(e){this.currentSubclass=e}setBowReleaseCallback(e){this.onBowReleaseCallback=e}setDivineStormCallback(e){this.onDivineStormCallback=e}setProjectileCreatedCallback(e){this.onProjectileCreatedCallback=e}setViperStingCallback(e){this.onViperStingCallback=e}setBarrageCallback(e){this.onBarrageCallback=e}setReanimateCallback(e){this.onReanimateCallback=e}setFrostNovaCallback(e){this.onFrostNovaCallback=e}setCobraShotCallback(e){this.onCobraShotCallback=e}setChargeCallback(e){this.onChargeCallback=e}setDeflectCallback(e){this.onDeflectCallback=e}setSkyfallCallback(e){this.onSkyfallCallback=e}setBackstabCallback(e){this.onBackstabCallback=e}setDebuffCallback(e){this.onDebuffCallback=e}triggerBowReleaseEffects(e){this.onBowReleaseCallback&&this.onBowReleaseCallback(e,e>=.75&&e<=.98)}setWeaponLevel(e){this.currentLevel=e}getCurrentWeaponConfig(){return{weapon:this.currentWeapon,subclass:this.currentSubclass,level:this.currentLevel}}getCurrentWeapon(){return this.currentWeapon}getCurrentSubclass(){return this.currentSubclass}isWeaponCharging(){return this.isCharging}getChargeProgress(){return this.chargeProgress}isViperStingChargingActive(){return this.isViperStingCharging}getViperStingChargeProgress(){return this.viperStingChargeProgress}isBarrageChargingActive(){return this.isBarrageCharging}getBarrageChargeProgress(){return this.barrageChargeProgress}isCobraShotChargingActive(){return this.isCobraShotCharging}getCobraShotChargeProgress(){return this.cobraShotChargeProgress}isWeaponSwinging(){return this.isSwinging}getSwordComboStep(){return this.swordComboStep}isDivineStormActive(){return this.isDivineStorming}isChargeActive(){return this.isSwordCharging}isDeflectActive(){return this.isDeflecting}isSkyfallActive(){return this.isSkyfalling}isBackstabActive(){return this.isBackstabbing}handleSwordInput(e){!this.inputManager.isMouseButtonPressed(0)||this.isSwinging||this.isDivineStorming||this.isSwordCharging||this.isDeflecting||this.performSwordMeleeAttack(e),!this.inputManager.isKeyPressed("r")||this.isDivineStorming||this.isSwinging||this.isSwordCharging||this.isDeflecting||this.performDivineStorm(e),!this.inputManager.isKeyPressed("e")||this.isSwordCharging||this.isDivineStorming||this.isSwinging||this.isDeflecting||this.performCharge(e),!this.inputManager.isKeyPressed("q")||this.isDeflecting||this.isDivineStorming||this.isSwinging||this.isSwordCharging||this.performDeflect(e),Date.now()/1e3-this.lastSwordAttackTime>this.swordComboResetTime&&(this.swordComboStep=1)}performSwordMeleeAttack(e){let t=Date.now()/1e3;t-this.lastFireTime<this.swordFireRate||(this.lastFireTime=t,this.lastSwordAttackTime=t,this.isSwinging=!0,this.performMeleeDamage(e))}onSwordSwingComplete(){this.isSwinging&&(this.isSwinging=!1,this.swordComboStep=this.swordComboStep%3+1)}handleSabresInput(e){!this.inputManager.isMouseButtonPressed(0)||this.isSwinging||this.isSkyfalling||this.performSabresMeleeAttack(e),!this.inputManager.isKeyPressed("q")||this.isSwinging||this.isSkyfalling||this.performBackstab(e),this.inputManager.isKeyPressed("e")&&!this.isSkyfalling&&this.performSkyfall(e),this.isSkyfalling&&this.updateSkyfallMovement(e),this.isBackstabbing&&this.updateBackstabState(e)}performSabresMeleeAttack(e){let t=Date.now()/1e3;t-this.lastFireTime<this.sabresFireRate||(this.lastFireTime=t,console.log(" Sabres dual attack initiated"),this.isSwinging=!0,this.performSabresMeleeDamage(e))}onSabresSwingComplete(){this.isSwinging&&(console.log(" Sabres dual swing completed"),this.isSwinging=!1)}performSabresMeleeDamage(e){Date.now();let t=this.world.getAllEntities().filter(e=>e.hasComponent(r.S)&&e.hasComponent(n.w)&&e!==this.playerEntity),i=Math.PI/2,a=new s.Vector3;for(let s of(this.camera.getWorldDirection(a),a.normalize(),t)){let t=s.getComponent(n.w),o=s.getComponent(r.S);if(!t||!o||o.isDead)continue;let h=t.position.clone().sub(e.position);if(h.length()>3.8||(h.normalize(),Math.acos(Math.max(-1,Math.min(1,a.dot(h))))>i/2))continue;let l=this.world.getSystem(d.b);l&&(l.queueDamage(s,19,this.playerEntity||void 0),setTimeout(()=>{o.isDead||l.queueDamage(s,23,this.playerEntity||void 0)},100))}}performSkyfall(e){var t;let i=Date.now()/1e3;if(i-this.lastSkyfallTime<this.skyfallCooldown)return;let a=window.gameUI;if(!a||!a.canCastSkyfall())return;a.consumeEnergy(40),this.isSkyfalling=!0,this.skyfallPhase="ascending",this.skyfallStartTime=i,this.lastSkyfallTime=i,this.skyfallStartPosition.copy(e.position);let n=null===(t=this.playerEntity)||void 0===t?void 0:t.getComponent(o.i);if(n&&(this.skyfallOriginalGravity=n.gravity,this.skyfallTargetHeight=e.position.y+1.4*n.jumpForce,n.velocity.y=2*n.jumpForce,n.gravity=0),this.onSkyfallCallback){let t=new s.Vector3;this.camera.getWorldDirection(t),this.onSkyfallCallback(e.position,t)}}updateSkyfallMovement(e){var t;let i=Date.now()/1e3,s=null===(t=this.playerEntity)||void 0===t?void 0:t.getComponent(o.i);if(!s)return;let a=i-this.skyfallStartTime;switch(this.skyfallPhase){case"ascending":(e.position.y>=this.skyfallTargetHeight||s.velocity.y<=0)&&(this.skyfallPhase="descending",s.velocity.y=0,s.gravity=30*this.skyfallOriginalGravity);break;case"descending":e.position.y<=this.skyfallStartPosition.y+.5&&(this.skyfallPhase="landing",this.performSkyfallLanding(e));break;case"landing":this.completeSkyfallAbility(e)}a>4&&this.completeSkyfallAbility(e)}performSkyfallLanding(e){let t=this.world.getAllEntities(),i=e.position;for(let e of t){if(e===this.playerEntity)continue;let t=e.getComponent(r.S),s=e.getComponent(n.w);if(t&&s&&!t.isDead&&4>=i.distanceTo(s.position)){let t=this.world.getSystem(d.b);t&&t.queueDamage(e,125,this.playerEntity||void 0)}}}completeSkyfallAbility(e){var t;this.isSkyfalling=!1,this.skyfallPhase="none";let i=null===(t=this.playerEntity)||void 0===t?void 0:t.getComponent(o.i);i&&(i.gravity=this.skyfallOriginalGravity,i.velocity.y=0)}updateBackstabState(e){Date.now()/1e3-this.backstabStartTime>=this.backstabDuration&&(this.isBackstabbing=!1)}resetAllAbilityStates(){this.isSkyfalling=!1,this.skyfallPhase="none",this.isBackstabbing=!1,this.isDivineStorming=!1,this.isSwordCharging=!1,this.isDeflecting=!1}performBackstab(e){let t=Date.now()/1e3;if(t-this.lastBackstabTime<this.backstabCooldown)return;let i=window.gameUI;if(i&&i.canCastBackstab()){if(i.consumeEnergy(60),this.lastBackstabTime=t,this.isBackstabbing=!0,this.backstabStartTime=t,this.onBackstabCallback){let t=new s.Vector3;this.camera.getWorldDirection(t),this.onBackstabCallback(e.position,t,75,!1)}this.performBackstabDamage(e)}}performBackstabDamage(e){let t=this.world.getAllEntities(),i=e.position,a=new s.Vector3;for(let e of(this.camera.getWorldDirection(a),a.normalize(),t)){if(e===this.playerEntity)continue;let t=e.getComponent(r.S),o=e.getComponent(n.w);if(!t||!o||t.isDead||i.distanceTo(o.position)>2.5)continue;let h=new s.Vector3().subVectors(o.position,i).normalize();if(a.dot(h)<Math.cos(Math.PI/3))continue;let l=75,c=window.pvpPlayers,m=window.localSocketId;if(c&&m){let e=null;for(let[t,i]of c)if(t!==m&&.5>new s.Vector3(i.position.x,i.position.y,i.position.z).distanceTo(o.position)){e=i;break}if(e){let t=new s.Vector3(Math.sin(e.rotation.y),0,Math.cos(e.rotation.y)).normalize(),a=new s.Vector3().subVectors(i,o.position).normalize();-.3>t.dot(a)&&(l=175)}}let u=this.world.getSystem(d.b);u&&u.queueDamage(e,l,this.playerEntity,"backstab")}}performMeleeDamage(e){let t=this.world.getAllEntities(),i=e.position,a=new s.Vector3;this.camera.getWorldDirection(a),a.normalize();let o=Math.PI/2,h=45;switch(this.swordComboStep){case 1:h=40;break;case 2:h=45;break;case 3:h=55}let l=this.world.getSystem(d.b),c=0;if(t.forEach(e=>{var t;let s=e.getComponent(n.w),d=e.getComponent(r.S);if(!s||!d||e.id===(null===(t=this.playerEntity)||void 0===t?void 0:t.id))return;let m=s.position.clone().sub(i);4.5>=m.length()&&(m.normalize(),a.angleTo(m)<=o/2&&l&&this.playerEntity&&(l.queueDamage(e,h,this.playerEntity,"melee"),c++))}),c>0){let e=window.gameUI;if(e){let t=Math.min(5*c,5);e.gainRage(t)}}}checkForDashInput(e,t){for(let{key:i,direction:a}of[{key:"w",direction:new s.Vector3(0,0,-1)},{key:"s",direction:new s.Vector3(0,0,1)},{key:"a",direction:new s.Vector3(-1,0,0)},{key:"d",direction:new s.Vector3(1,0,0)}])if(this.inputManager.checkDoubleTap(i)){this.inputManager.getDoubleTapDebugInfo(i);let s=this.getWorldSpaceDirection(a),n=Date.now()/1e3;e.startDash(s,t.position,n)&&this.inputManager.resetDoubleTap(i);break}}handleDashMovement(e,t){if(!e.isDashing)return;let i=Date.now()/1e3,s=e.updateDash(i);s.newPosition&&(29>=s.newPosition.length()?t.position.copy(s.newPosition):e.cancelDash())}handleChargeMovement(e,t){if(!e.isCharging)return;let i=Date.now()/1e3;if(this.chargeStoppedByCollision){e.cancelCharge();return}let s=e.updateCharge(i);if(s.newPosition){let i=s.newPosition.length(),a=this.checkPillarCollision(s.newPosition);i>29?(e.cancelCharge(),this.onChargeComplete()):a.hasCollision?(console.warn("Charge cancelled: would collide with pillar at [".concat(a.pillarCenter.toArray().join(", "),"]")),e.cancelCharge(),this.onChargeComplete()):this.chargeStoppedByCollision||t.position.copy(s.newPosition)}(s.isComplete||this.chargeStoppedByCollision)&&(console.log(" Charge movement completed"),this.onChargeComplete())}checkPillarCollision(e){for(let t of this.PILLAR_POSITIONS){let i=new s.Vector3(e.x,0,e.z),a=new s.Vector3(t.x,0,t.z);if(i.distanceTo(a)<this.PILLAR_RADIUS){let e=i.clone().sub(a).normalize();return 0===e.length()&&e.set(1,0,0),{hasCollision:!0,normal:e,pillarCenter:t.clone()}}}return{hasCollision:!1,normal:new s.Vector3,pillarCenter:new s.Vector3}}getWorldSpaceDirection(e){let t=new s.Vector3;this.camera.getWorldDirection(t);let i=new s.Vector3;i.crossVectors(t,new s.Vector3(0,1,0)).normalize();let a=new s.Vector3;a.crossVectors(new s.Vector3(0,1,0),i).normalize();let n=new s.Vector3;return n.addScaledVector(i,e.x),n.addScaledVector(a,-e.z),n.normalize(),n}performDivineStorm(e){let t=window.gameUI;if(t&&!t.canCastDivineStorm())return;let i=Date.now()/1e3;if(i-this.lastDivineStormTime<this.divineStormCooldown)return;let a=t?t.getCurrentRage():40;t&&t.consumeAllRage();let n=1e3+500*Math.floor(a/10);if(this.isDivineStorming=!0,this.lastDivineStormTime=i,this.onDivineStormCallback){let t=new s.Vector3;this.camera.getWorldDirection(t),t.normalize(),this.onDivineStormCallback(e.position.clone(),t,n)}setTimeout(()=>{this.isDivineStorming=!1},n)}performCharge(e){let t=Date.now()/1e3;if(t-this.lastChargeTime<this.chargeCooldown)return;if(this.isSwordCharging=!0,this.lastChargeTime=t,this.chargeStoppedByCollision=!1,this.onChargeCallback){let t=new s.Vector3;this.camera.getWorldDirection(t),t.normalize(),this.onChargeCallback(e.position.clone(),t)}let i=window.gameUI;if(i&&i.gainRage(20),this.playerEntity){let i=this.playerEntity.getComponent(o.i);if(i){let a=new s.Vector3;this.camera.getWorldDirection(a),a.y=0,a.normalize(),i.startCharge(a,e.position,t)&&this.scheduleChargeDamage(e,a,t)}}}scheduleChargeDamage(e,t,i){this.chargeHitEntities.clear(),this.chargeStoppedByCollision=!1;let a=setInterval(()=>{let l=Date.now()/1e3;if(!this.isSwordCharging||l-i>.6||this.chargeStoppedByCollision){clearInterval(a);return}let m=this.world.getAllEntities(),u=e.position,g=!1,p=window.pvpPlayers||new Map,y=window.localSocketId;if(p.forEach((e,i)=>{if(i===y)return;let a=1e3*i.length+i.charCodeAt(0);if(this.chargeHitEntities.has(a))return;let n=new s.Vector3(e.position.x,e.position.y,e.position.z);1.9>=u.distanceTo(n)&&e.health>0&&(this.chargeHitEntities.add(a),g=!0,this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("sword_charge_hit",u.clone(),t.clone(),{damage:40,targetId:i,hitPosition:{x:n.x,y:n.y,z:n.z}}))}),m.forEach(e=>{var i;if(e.id===(null===(i=this.playerEntity)||void 0===i?void 0:i.id)||this.chargeHitEntities.has(e.id))return;let s=e.getComponent(n.w),a=e.getComponent(r.S),o=e.getComponent(c.YM),l=e.getComponent(h.C);if(l?l.getDisplayName():e.id,!s||!a||a.isDead)return;let m=s.position;if(u.distanceTo(m)<=(o?o.radius+1:2.5)){this.chargeHitEntities.add(e.id),g=!0;let i=this.world.getSystem(d.b);if(i&&this.playerEntity){i.queueDamage(e,40,this.playerEntity,"charge");let s=e.getComponent(h.C);s?s.getDisplayName():e.id,this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("sword_charge_hit",u.clone(),t.clone(),{damage:40,targetId:e.id,hitPosition:{x:m.x,y:m.y,z:m.z}})}}}),g){if(this.chargeStoppedByCollision=!0,this.playerEntity){let e=this.playerEntity.getComponent(o.i);e&&e.cancelCharge()}clearInterval(a),this.onChargeComplete()}},50)}onChargeComplete(){this.isSwordCharging=!1}performDeflect(e){let t=Date.now()/1e3;if(!(t-this.lastDeflectTime<this.deflectCooldown)){if(this.isDeflecting=!0,this.lastDeflectTime=t,this.onDeflectCallback){let t=new s.Vector3;this.camera.getWorldDirection(t),t.normalize(),this.onDeflectCallback(e.position.clone(),t)}this.setupDeflectBarrier(e),setTimeout(()=>{this.onDeflectComplete()},1e3*this.deflectDuration)}}performViperSting(e){let t=Date.now()/1e3;if(t-this.lastViperStingTime<this.viperStingFireRate)return;let i=window.gameUI;if(i&&!i.canCastViperSting())return;i&&i.consumeEnergy(60),this.isViperStingCharging=!0,this.viperStingChargeProgress=0,this.lastViperStingTime=t;let s=Date.now(),a=setInterval(()=>{let t=Date.now()-s;this.viperStingChargeProgress=Math.min(t/1e3,1),this.viperStingChargeProgress>=1&&(clearInterval(a),this.fireViperSting(e),this.isViperStingCharging=!1,this.viperStingChargeProgress=0)},16)}fireViperSting(e){let t=e.getWorldPosition();t.y+=.825;let i=new s.Vector3;this.camera.getWorldDirection(i),i.normalize();let a=new s.Vector3;a.crossVectors(i,new s.Vector3(0,1,0)).normalize();let n=new s.Matrix4;n.makeRotationAxis(a,Math.PI/6),i.applyMatrix4(n),i.normalize();let o=t.clone();o.add(i.clone().multiplyScalar(1)),this.onViperStingCallback&&this.onViperStingCallback(t,i),(0,y.triggerGlobalViperSting)(),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("viper_sting_projectile",o,i,{speed:16,damage:61,lifetime:5,isReturning:!1})}performBarrage(e){let t=Date.now()/1e3;if(t-this.lastBarrageTime<this.barrageFireRate){console.log(" Barrage on cooldown for ".concat((this.barrageFireRate-(t-this.lastBarrageTime)).toFixed(1),"s"));return}let i=window.gameUI;if(i&&!i.canCastBarrage())return;i&&i.consumeEnergy(40),this.isBarrageCharging=!0,this.barrageChargeProgress=0,this.lastBarrageTime=t;let s=Date.now(),a=setInterval(()=>{let t=Date.now()-s;this.barrageChargeProgress=Math.min(t/500,1),this.barrageChargeProgress>=1&&(clearInterval(a),this.fireBarrage(e),this.isBarrageCharging=!1,this.barrageChargeProgress=0)},16)}fireBarrage(e){let t=e.getWorldPosition();t.y+=.825;let i=new s.Vector3;this.camera.getWorldDirection(i);let a=new s.Vector3;a.crossVectors(i,new s.Vector3(0,1,0)).normalize();let n=new s.Matrix4;n.makeRotationAxis(a,Math.PI/6),i.applyMatrix4(n),i.normalize(),[0,Math.PI/12,-Math.PI/12,Math.PI/6,-Math.PI/6].forEach(e=>{let a=i.clone(),n=new s.Matrix4().makeRotationY(e);a.applyMatrix4(n),a.normalize();let o=t.clone();o.add(a.clone().multiplyScalar(1));let r={speed:22,damage:30,lifetime:8,maxDistance:25,piercing:!1,subclass:this.currentSubclass,level:1,opacity:1},h=this.projectileSystem.createProjectile(this.world,o,a,this.playerEntity.id,r).getComponent(l.T);(null==h?void 0:h.mesh)&&(h.mesh.userData.isBarrageArrow=!0,h.mesh.userData.isRegularArrow=!1),this.onProjectileCreatedCallback&&this.onProjectileCreatedCallback("barrage_projectile",o,a,r)}),this.onBarrageCallback&&this.onBarrageCallback(t,i)}setupDeflectBarrier(e){let t=e.getWorldPosition(),i=new s.Vector3(0,0,0);if(this.playerEntity){let e=this.playerEntity.getComponent(o.i);if(e&&e.inputStrength>.1){let t=e.moveDirection;if(t.length()>.1){let e=Math.atan2(t.x,t.z);i.y=e}}else{let e=new s.Vector3;this.camera.getWorldDirection(e),i.y=Math.atan2(e.x,e.z)}}this.deflectBarrier.activate(t,i,this.playerEntity||void 0)}updateDeflectBarrier(e){if(this.deflectBarrier.isBarrierActive()){let t=e.getWorldPosition(),i=new s.Vector3(0,0,0);if(this.playerEntity){let e=this.playerEntity.getComponent(o.i);if(e&&e.inputStrength>.1){let t=e.moveDirection;if(t.length()>.1){let e=Math.atan2(t.x,t.z);i.y=e}}else{let e=new s.Vector3;this.camera.getWorldDirection(e),i.y=Math.atan2(e.x,e.z)}}this.deflectBarrier.updatePosition(t,i)}}onDeflectComplete(){this.isDeflecting=!1,this.deflectBarrier.deactivate()}getWeaponSwitchCooldown(){let e=Date.now()/1e3;return{current:Math.max(0,this.weaponSwitchCooldown-(e-this.lastWeaponSwitchTime)),max:this.weaponSwitchCooldown}}getAbilityCooldowns(){let e=Date.now()/1e3,t={};return this.currentWeapon===m.v.SWORD?(t.Q={current:Math.max(0,this.deflectCooldown-(e-this.lastDeflectTime)),max:this.deflectCooldown,isActive:this.isDeflecting},t.E={current:Math.max(0,this.chargeCooldown-(e-this.lastChargeTime)),max:this.chargeCooldown,isActive:this.isSwordCharging},t.R={current:Math.max(0,this.divineStormCooldown-(e-this.lastDivineStormTime)),max:this.divineStormCooldown,isActive:this.isDivineStorming}):this.currentWeapon===m.v.BOW?(t.Q={current:Math.max(0,this.barrageFireRate-(e-this.lastBarrageTime)),max:this.barrageFireRate,isActive:this.isBarrageCharging},t.E={current:Math.max(0,this.cobraShotFireRate-(e-this.lastCobraShotTime)),max:this.cobraShotFireRate,isActive:!1},t.R={current:Math.max(0,this.viperStingFireRate-(e-this.lastViperStingTime)),max:this.viperStingFireRate,isActive:this.isViperStingCharging}):this.currentWeapon===m.v.SCYTHE?(t.Q={current:Math.max(0,1-(e-this.lastReanimateTime)),max:1,isActive:!1},t.E={current:Math.max(0,this.frostNovaFireRate-(e-this.lastFrostNovaTime)),max:this.frostNovaFireRate,isActive:!1},t.R={current:Math.max(0,this.crossentropyFireRate-(e-this.lastCrossentropyTime)),max:this.crossentropyFireRate,isActive:!1}):this.currentWeapon===m.v.SABRES&&(t.Q={current:Math.max(0,this.backstabCooldown-(e-this.lastBackstabTime)),max:this.backstabCooldown,isActive:!1},t.E={current:Math.max(0,this.skyfallCooldown-(e-this.lastSkyfallTime)),max:this.skyfallCooldown,isActive:this.isSkyfalling},t.R={current:0,max:0,isActive:!1}),t}constructor(e,t,i,a){super(),this.requiredComponents=[n.w,o.i],this.playerEntity=null,this.lastFireTime=0,this.lastCrossentropyTime=0,this.lastReanimateTime=0,this.lastViperStingTime=0,this.lastFrostNovaTime=0,this.lastCobraShotTime=0,this.fireRate=.225,this.swordFireRate=.9,this.sabresFireRate=.6,this.scytheFireRate=.33,this.crossentropyFireRate=2,this.viperStingFireRate=2.5,this.frostNovaFireRate=12,this.cobraShotFireRate=2.5,this.currentWeapon=m.v.BOW,this.currentSubclass=m.p.ELEMENTAL,this.currentLevel=1,this.isCharging=!1,this.chargeProgress=0,this.isSwinging=!1,this.isViperStingCharging=!1,this.viperStingChargeProgress=0,this.isBarrageCharging=!1,this.barrageChargeProgress=0,this.lastBarrageTime=0,this.barrageFireRate=5,this.isCobraShotCharging=!1,this.cobraShotChargeProgress=0,this.swordComboStep=1,this.lastSwordAttackTime=0,this.swordComboResetTime=1,this.isDivineStorming=!1,this.lastDivineStormTime=0,this.divineStormCooldown=8,this.isSwordCharging=!1,this.lastChargeTime=0,this.chargeCooldown=8,this.isDeflecting=!1,this.lastDeflectTime=0,this.deflectCooldown=6,this.deflectDuration=3,this.isSkyfalling=!1,this.skyfallPhase="none",this.lastSkyfallTime=0,this.skyfallCooldown=5,this.skyfallStartTime=0,this.skyfallStartPosition=new s.Vector3,this.skyfallTargetHeight=0,this.skyfallOriginalGravity=0,this.lastBackstabTime=0,this.backstabCooldown=2,this.isBackstabbing=!1,this.backstabStartTime=0,this.backstabDuration=1,this.lastWeaponSwitchTime=0,this.weaponSwitchCooldown=1.5,this.PILLAR_POSITIONS=[new s.Vector3(0,0,-5),new s.Vector3(-4.25,0,2.5),new s.Vector3(4.25,0,2.5)],this.PILLAR_RADIUS=.7,this.chargeHitEntities=new Set,this.chargeStoppedByCollision=!1,this.camera=e,this.inputManager=t,this.world=i,this.projectileSystem=a,this.deflectBarrier=new u.l(i),this.priority=5}}},4451:function(e,t,i){i.d(t,{C:function(){return h}});var s=i(1448),a=i(9131),n=i(73),o=i(6862),r=i(6776);class h extends a.Kg{update(e,t){for(let i of e){let e=i.getComponent(n.w),s=i.getComponent(o.S),a=i.getComponent(r.T);if(!e.enabled||!s.enabled||!a.enabled)continue;let h=e.getWorldPosition(),l=this.camera.position;a.updateHealthBar(s.getHealthRatio(),l,h,t)}}render(e,t){}onEntityAdded(e){let t=e.getComponent(r.T);t&&this.scene.add(t.getGroup())}onEntityRemoved(e){let t=e.getComponent(r.T);t&&(this.scene.remove(t.getGroup()),t.dispose())}onDisable(){let e=[];for(let t of(this.scene.traverse(t=>{t instanceof s.Group&&t.userData.isHealthBar&&e.push(t)}),e))this.scene.remove(t)}constructor(e,t){super(),this.requiredComponents=[n.w,o.S,r.T],this.scene=e,this.camera=t,this.priority=100}}},5773:function(e,t,i){i.d(t,{F:function(){return r}});var s=i(1448),a=i(9131),n=i(73),o=i(7771);class r extends a.FU{update(e,t){for(let i of e){let e=i.getComponent(n.w),s=i.getComponent(o.i);e&&s&&e.enabled&&s.enabled&&s.canMove&&("function"==typeof s.updateDebuffs?s.updateDebuffs():console.warn(" Movement component missing updateDebuffs method:",s),this.updateMovement(e,s,t))}}fixedUpdate(e,t){for(let i of e){let e=i.getComponent(n.w),s=i.getComponent(o.i);e&&s&&e.enabled&&s.enabled&&s.canMove&&this.applyPhysics(e,s,t)}}updateMovement(e,t,i){let a=t.velocity.clone().multiplyScalar(i),n=e.position.clone(),o=n.clone().add(a),r=new s.Vector3(o.x,0,o.z).length(),h=this.checkPillarCollision(o);if(r>=29){let t=new s.Vector3(n.x,0,n.z),i=t.clone().normalize(),o=new s.Vector3(-i.z,0,i.x),r=new s.Vector3(a.x,0,a.z),h=o.multiplyScalar(r.dot(o)),l=t.add(h);l.normalize().multiplyScalar(29),e.setPosition(l.x,n.y+a.y,l.z)}else if(h.hasCollision){let i=this.calculatePillarSliding(n,a,h);e.setPosition(i.x,i.y,i.z);let s=t.velocity.clone().projectOnVector(h.normal);t.velocity.sub(s.multiplyScalar(.5))}else e.translate(a.x,a.y,a.z);e.matrixNeedsUpdate=!0}checkPillarCollision(e){for(let t of this.PILLAR_POSITIONS){let i=new s.Vector3(e.x,0,e.z),a=new s.Vector3(t.x,0,t.z);if(i.distanceTo(a)<this.PILLAR_RADIUS){let e=i.clone().sub(a).normalize();return 0===e.length()&&e.set(1,0,0),{hasCollision:!0,normal:e,pillarCenter:t.clone()}}}return{hasCollision:!1,normal:new s.Vector3,pillarCenter:new s.Vector3}}calculatePillarSliding(e,t,i){let a=new s.Vector3(-i.normal.z,0,i.normal.x),n=t.clone().projectOnVector(a),o=e.clone().add(n),r=new s.Vector3(i.pillarCenter.x,0,i.pillarCenter.z),h=new s.Vector3(o.x,0,o.z);if(h.distanceTo(r)<this.PILLAR_RADIUS){let e=h.clone().sub(r).normalize();0===e.length()&&e.set(1,0,0);let t=r.clone().add(e.multiplyScalar(this.PILLAR_RADIUS));o.x=t.x,o.z=t.z}return o}applyPhysics(e,t,i){if(t.applyGravity(i),t.inputStrength>0){let e=t.getEffectiveMaxSpeed(),i=t.moveDirection.clone();i.multiplyScalar(e*t.inputStrength),t.velocity.x=i.x,t.velocity.z=i.z}else t.velocity.x=0,t.velocity.z=0;t.velocity.add(t.acceleration.clone().multiplyScalar(i)),t.acceleration.set(0,0,0),e.position.y<=.5&&t.velocity.y<=0?(e.position.y=.5,t.velocity.y=0,t.isGrounded=!0):t.isGrounded=!1}constructor(){super(),this.requiredComponents=[n.w,o.i],this.PILLAR_POSITIONS=[new s.Vector3(0,0,-5),new s.Vector3(-4.25,0,2.5),new s.Vector3(4.25,0,2.5)],this.PILLAR_RADIUS=.7,this.priority=15}}},2972:function(e,t,i){i.d(t,{c:function(){return d}});var s=i(1448),a=i(9131),n=i(73),o=i(1168),r=i(6862),h=i(246),l=i(3478),c=i(6520);class d extends a.xP{setCombatSystem(e){this.combatSystem=e}update(e,t){for(let i of(this.projectilesToDestroy.length=0,e)){let e=i.getComponent(n.w),s=i.getComponent(o.W);if(e.enabled&&s.enabled){if(s.update(t),s.isExpired()){this.projectilesToDestroy.push(i.id);continue}this.moveProjectile(e,s,t),this.checkCollisions(i,e,s),this.checkWorldBounds(i,e)}}for(let e of this.projectilesToDestroy)this.world.destroyEntity(e)}moveProjectile(e,t,i){this.tempVector.copy(t.velocity).multiplyScalar(i),e.translate(this.tempVector.x,this.tempVector.y,this.tempVector.z),e.matrixNeedsUpdate=!0}checkCollisions(e,t,i){let s=t.position,a=this.world.queryEntities([n.w,r.S,l.YM]);if(0!==a.length)for(let t of a){if(t.id===e.id||t.id===i.owner){t.id,i.owner;continue}if(!i.canHitTarget(t.id))continue;let a=t.getComponent(n.w),o=t.getComponent(r.S),h=t.getComponent(l.YM);if(o.isDead||h.layer!==l.aB.ENEMY&&h.layer!==l.aB.PLAYER||h.layer===l.aB.PLAYER&&t.id===i.owner)continue;let c=a.getWorldPosition(),d=h.radius;if(s.distanceToSquared(c)<=(.2+d)**2&&(this.handleHit(e,t,i,o),!i.piercing)){this.projectilesToDestroy.push(e.id);break}}}handleHit(e,t,i,s){if(i.addHitTarget(t.id),this.combatSystem){var a,n,o,r;let s=e.getComponent(h.T),l=null==s?void 0:null===(n=s.mesh)||void 0===n?void 0:null===(a=n.userData)||void 0===a?void 0:a.isCrossentropyBolt,c=null==s?void 0:null===(r=s.mesh)||void 0===r?void 0:null===(o=r.userData)||void 0===o?void 0:o.isEntropicBolt,d="projectile";l?d="crossentropy":c&&(d="entropic"),this.combatSystem.queueDamage(t,i.damage,e,d)}else{let e=Date.now()/1e3;s.takeDamage(i.damage,e,t)}i.explosionRadius>0&&this.handleExplosion(e,i)}handleExplosion(e,t){let i=e.getComponent(n.w).position;for(let e of(this.world.emitEvent("explosion",{position:i.clone(),color:new s.Color("#00ff44"),size:t.explosionRadius,duration:.5}),this.world.queryEntities([n.w,r.S]))){if(e.id===t.owner)continue;let s=e.getComponent(n.w),a=e.getComponent(r.S),o=i.distanceTo(s.position);if(o<=t.explosionRadius){let i=1-o/t.explosionRadius,s=Math.floor(t.damage*i);if(s>0){let t=Date.now()/1e3;a.takeDamage(s,t,e)}}}}checkWorldBounds(e,t){let i=t.position;if(i.lengthSq()>1600){this.projectilesToDestroy.push(e.id);return}i.y<-10&&this.projectilesToDestroy.push(e.id)}createChargedArrowProjectile(e,t,i,a,r){let c=e.createEntity(),d=e.createComponent(n.w);d.position.copy(t),c.addComponent(d);let m=e.createComponent(o.W);m.speed=(null==r?void 0:r.speed)||35,m.damage=(null==r?void 0:r.damage)||25,m.maxLifetime=(null==r?void 0:r.lifetime)||5,m.owner=a,m.setDirection(i),(null==r?void 0:r.piercing)&&m.setPiercing(!0),(null==r?void 0:r.explosive)&&(null==r?void 0:r.explosionRadius)&&m.setExplosive(r.explosionRadius),c.addComponent(m);let u=e.createComponent(h.T),g=new s.SphereGeometry(.15,8,8),p=new s.MeshStandardMaterial({color:"#ffaa00",emissive:"#ffaa00",emissiveIntensity:3,transparent:!0,opacity:.1}),y=new s.Mesh(g,p);y.userData.isChargedArrow=!0,y.userData.direction=i.clone(),y.userData.subclass=null==r?void 0:r.subclass,y.userData.level=null==r?void 0:r.level,y.userData.opacity=(null==r?void 0:r.opacity)||1,u.mesh=y,c.addComponent(u);let f=e.createComponent(l.YM);return f.radius=.15,f.layer=l.aB.PROJECTILE,c.addComponent(f),c}createCrossentropyBoltProjectile(e,t,i,a,r){let l=e.createEntity(),c=e.createComponent(n.w);c.position.copy(t),l.addComponent(c);let d=e.createComponent(o.W);d.speed=(null==r?void 0:r.speed)||20,d.damage=(null==r?void 0:r.damage)||30,d.maxLifetime=(null==r?void 0:r.lifetime)||1.75,d.owner=a,d.setDirection(i),(null==r?void 0:r.piercing)&&d.setPiercing(!0),(null==r?void 0:r.explosive)&&(null==r?void 0:r.explosionRadius)&&d.setExplosive(r.explosionRadius),l.addComponent(d);let m=e.createComponent(h.T),u=new s.SphereGeometry(.28,8,8),g=new s.MeshStandardMaterial({color:"#00ff44",emissive:"#00ff44",emissiveIntensity:0,transparent:!0,opacity:0}),p=new s.Mesh(u,g);return p.userData.isCrossentropyBolt=!0,p.userData.projectileEntity=l,p.userData.direction=i.clone(),m.mesh=p,"function"==typeof m.setCastShadow?m.setCastShadow(!1):console.warn(" Renderer component missing setCastShadow method:",m),l.addComponent(m),this.world.notifyEntityAdded(l),l}createEntropicBoltProjectile(e,t,i,a,r){let l=e.createEntity(),c=e.createComponent(n.w);c.position.copy(t),l.addComponent(c);let d=e.createComponent(o.W);d.speed=(null==r?void 0:r.speed)||20,d.damage=(null==r?void 0:r.damage)||20,d.maxLifetime=(null==r?void 0:r.lifetime)||1.75,d.owner=a,d.setDirection(i),(null==r?void 0:r.piercing)&&d.setPiercing(!0),(null==r?void 0:r.explosive)&&(null==r?void 0:r.explosionRadius)&&d.setExplosive(r.explosionRadius),l.addComponent(d);let m=e.createComponent(h.T),u=new s.SphereGeometry(.15,6,6),g=new s.MeshStandardMaterial({color:"#00ff44",emissive:"#00ff44",emissiveIntensity:0,transparent:!0,opacity:0}),p=new s.Mesh(u,g);return p.userData.isEntropicBolt=!0,p.userData.projectileEntity=l,p.userData.direction=i.clone(),m.mesh=p,"function"==typeof m.setCastShadow?m.setCastShadow(!1):console.warn(" Renderer component missing setCastShadow method:",m),l.addComponent(m),this.world.notifyEntityAdded(l),l}createProjectile(e,t,i,a,r){let c=e.createEntity(),d=e.createComponent(n.w);d.position.copy(t),c.addComponent(d);let m=e.createComponent(o.W);m.speed=(null==r?void 0:r.speed)||20,m.damage=(null==r?void 0:r.damage)||5,m.maxLifetime=(null==r?void 0:r.lifetime)||2,m.owner=a,m.setDirection(i),m.setStartPosition(t),(null==r?void 0:r.maxDistance)!==void 0&&m.setMaxDistance(r.maxDistance),(null==r?void 0:r.piercing)&&m.setPiercing(!0),(null==r?void 0:r.explosive)&&(null==r?void 0:r.explosionRadius)&&m.setExplosive(r.explosionRadius),c.addComponent(m);let u=e.createComponent(h.T),g=new s.SphereGeometry(.15,8,8),p=new s.MeshStandardMaterial({color:"#ffaa00",emissive:"#ffaa00",emissiveIntensity:3,transparent:!0,opacity:.1}),y=new s.Mesh(g,p);y.userData.isRegularArrow=!0,y.userData.direction=i.clone(),y.userData.subclass=null==r?void 0:r.subclass,y.userData.level=null==r?void 0:r.level,y.userData.opacity=(null==r?void 0:r.opacity)||1,u.mesh=y,"function"==typeof u.setCastShadow?u.setCastShadow(!1):console.warn(" Renderer component missing setCastShadow method:",u),c.addComponent(u);let f=e.createComponent(l.YM);return f.radius=.15,f.layer=l.aB.PROJECTILE,c.addComponent(f),this.world.notifyEntityAdded(c),c}getPoolStats(){return{vector3:this.vector3Pool.getPoolSize()}}onDisable(){console.log("\uD83E\uDDF9 Cleaning up ProjectileSystem pools:",this.getPoolStats()),this.vector3Pool.clear()}constructor(e){super(),this.requiredComponents=[n.w,o.W],this.combatSystem=null,this.projectilesToDestroy=[],this.tempVector=new s.Vector3,this.tempVector2=new s.Vector3,this.world=e,this.priority=20,this.vector3Pool=new c.L(()=>new s.Vector3,e=>e.set(0,0,0),100)}}},3842:function(e,t,i){i.d(t,{K:function(){return r}});var s=i(1448),a=i(9131),n=i(73),o=i(246);class r extends a.Kg{update(e,t){for(let i of e){let e=i.getComponent(n.w),s=i.getComponent(o.T);e.enabled&&s.enabled&&("function"==typeof s.updateAnimations?s.updateAnimations(t):console.warn(" Renderer component missing updateAnimations method:",s),this.updateEntityMesh(i,e,s))}}render(e,t){for(let t of e){let e=t.getComponent(n.w),i=t.getComponent(o.T);e.enabled&&i.enabled&&this.updateEntityTransform(t,e,i)}this.renderer.render(this.scene,this.camera)}updateEntityMesh(e,t,i){let s=this.meshMap.get(e.id);if(!s&&i.mesh){this.meshMap.set(e.id,i.mesh),this.scene.add(i.mesh);return}if(!s&&i.geometry&&i.material){let t=i.createMesh();t&&(this.meshMap.set(e.id,t),this.scene.add(t))}else s&&("function"==typeof i.updateMesh?i.updateMesh():console.warn(" Renderer component missing updateMesh method:",i))}updateEntityTransform(e,t,i){let a=this.meshMap.get(e.id);a&&(t.updateMatrix(),a.position.copy(t.position),a.quaternion.copy(t.quaternion),a.scale.copy(t.scale),i.isInstanced&&a instanceof s.Mesh&&i.updateInstanceMatrix(t.matrix))}onEntityAdded(e){let t=e.getComponent(o.T);if(t){if(console.log("\uD83C\uDFA8 RenderSystem: Adding entity ".concat(e.id," to scene")),t.mesh){console.log("\uD83C\uDFF9 Adding pre-built mesh/group for entity ".concat(e.id)),this.meshMap.set(e.id,t.mesh),this.scene.add(t.mesh);return}if(t.geometry&&t.material){console.log("\uD83D\uDD37 Creating mesh from geometry + material for entity ".concat(e.id));let i=t.createMesh();i&&(this.meshMap.set(e.id,i),this.scene.add(i))}else console.log(" Entity ".concat(e.id," has Renderer but no geometry/material - skipping mesh creation"))}else console.log(" RenderSystem: Entity ".concat(e.id," has no Renderer component"))}onEntityRemoved(e){let t=this.meshMap.get(e.id);t&&(this.scene.remove(t),this.meshMap.delete(e.id));let i=e.getComponent(o.T);i&&"function"==typeof i.dispose&&i.dispose()}getMesh(e){return this.meshMap.get(e)}getScene(){return this.scene}getCamera(){return this.camera}getRenderer(){return this.renderer}addLight(e){this.scene.add(e)}removeLight(e){this.scene.remove(e)}addObject(e){this.scene.add(e)}removeObject(e){this.scene.remove(e)}setFog(e){this.scene.fog=e}setBackground(e){this.scene.background=e}enableShadows(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];this.renderer.shadowMap.enabled=e,this.renderer.shadowMap.type=s.PCFSoftShadowMap}setPixelRatio(e){this.renderer.setPixelRatio(e||window.devicePixelRatio)}setSize(e,t){this.renderer.setSize(e,t),this.camera instanceof s.PerspectiveCamera&&(this.camera.aspect=e/t,this.camera.updateProjectionMatrix())}dispose(){for(let[e,t]of Array.from(this.meshMap.entries()))this.scene.remove(t);this.meshMap.clear(),this.renderer.dispose()}constructor(e,t,i){super(),this.requiredComponents=[n.w,o.T],this.meshMap=new Map,this.scene=e,this.camera=t,this.renderer=i,this.priority=1e3}}},3021:function(e,t,i){i.d(t,{R:function(){return l}});var s=i(1448),a=i(9131),n=i(73),o=i(6862),r=i(2115),h=i(3478);class l extends a.xP{setProjectileSystem(e){this.projectileSystem=e}setTowerAttackCallback(e){this.onTowerAttackCallback=e}setPlayerMapping(e,t){this.serverPlayerEntities=e,this.localSocketId=t}update(e,t){let i=Date.now()/1e3;for(let t of e){let e=t.getComponent(n.w),s=t.getComponent(r.N),a=t.getComponent(o.S);if(e&&s&&a){if(a.isDead&&!s.isDead){s.die(i);continue}if(s.isActive&&!s.isDead){if(s.canSearchForTargets(i)&&this.searchForTarget(t,e,s,i),s.currentTarget){let t=this.world.getEntity(s.currentTarget);this.isValidTarget(t||null,e,s)||s.clearTarget()}s.currentTarget&&s.canAttack(i)&&this.attackTarget(t,e,s,i)}}}}searchForTarget(e,t,i,s){i.updateTargetSearch(s);let a=this.world.queryEntities([n.w,o.S,h.YM]),r=null,l=1/0;for(let e of a){let s=e.getComponent(h.YM),a=e.getComponent(n.w);if(s&&a&&t.position.distanceTo(a.position),!this.isValidTarget(e,t,i))continue;let o=e.getComponent(n.w);if(!o)continue;let c=t.position.distanceTo(o.position);c<=i.targetSearchRange&&c<l&&(r=e,l=c)}r?i.setTarget(r.id):i.currentTarget&&i.clearTarget()}isValidTarget(e,t,i){if(!e)return!1;let s=e.getComponent(o.S),a=e.getComponent(n.w),l=e.getComponent(h.YM);if(!s||!a||!l||s.isDead||l.layer!==h.aB.PLAYER&&l.layer!==h.aB.ENEMY||e.hasComponent(r.N))return!1;if(this.localSocketId&&this.serverPlayerEntities.size>0){if(l.layer===h.aB.PLAYER)return i.ownerId!==this.localSocketId;if(l.layer===h.aB.ENEMY){let t=null;if(this.serverPlayerEntities.forEach((i,s)=>{i===e.id&&(t=s)}),t)return i.ownerId!==t}}return!0}attackTarget(e,t,i,s){let a=this.world.getEntity(i.currentTarget);if(!a){i.clearTarget();return}let o=a.getComponent(n.w);if(!o||(this.tempVector.copy(o.position),this.tempVector.sub(t.position),this.tempVector.length()>i.attackRange)){i.clearTarget();return}if(this.tempVector.normalize(),this.tempVector2.copy(t.position),this.tempVector2.y+=2,this.projectileSystem){let t={speed:i.projectileSpeed,damage:i.attackDamage,lifetime:2,opacity:1},s=this.projectileSystem.createProjectile(this.world,this.tempVector2,this.tempVector,e.id,t);s.getComponent(n.w)&&(s.isTowerProjectile=!0,s.towerOwnerId=i.ownerId)}if(this.onTowerAttackCallback){let e="player_".concat(i.currentTarget);this.onTowerAttackCallback(i.ownerId,e,this.tempVector2,this.tempVector)}i.performAttack(s)}getTowersByOwner(e){return this.world.queryEntities([n.w,r.N,o.S]).filter(t=>{let i=t.getComponent(r.N);return i&&i.ownerId===e})}getTowerCount(e){return this.getTowersByOwner(e).length}hasActiveTowers(e){return this.getTowersByOwner(e).some(e=>{let t=e.getComponent(r.N),i=e.getComponent(o.S);return t&&i&&t.isActive&&!t.isDead&&!i.isDead})}constructor(e){super(),this.requiredComponents=[n.w,r.N,o.S],this.projectileSystem=null,this.serverPlayerEntities=new Map,this.localSocketId=null,this.tempVector=new s.Vector3,this.tempVector2=new s.Vector3,this.world=e,this.priority=25}}}}]);